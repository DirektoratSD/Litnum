<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="https://kemendikdasmen.go.id/web/image/website/21/favicon?unique=c3563e4">  
    <title>Pendampingan Litnum</title>
    <!-- PERBAIKAN: Mengganti xintegrity menjadi integrity -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Pengaturan Dasar Halaman */
        body, html {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            height: 100%;
            background-color: #f4f7f6;
        }

        /* Kontainer Utama (Flexbox) */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* MODIFIKASI: Sembunyikan app container by default */
        #app-container {
            display: none;
        }

        /* Sidebar (Menu Samping) */
        .sidebar {
            width: 240px;
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #ecf0f1;
        }

        .sidebar-menu {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li {
            margin-bottom: 10px;
        }

        .sidebar-menu li a {
            display: block;
            padding: 12px 15px;
            text-decoration: none;
            color: #bdc3c7;
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
            cursor: pointer;
        }

        .sidebar-menu li a:hover,
        .sidebar-menu li a.active {
            background-color: #34495e;
            color: #ffffff;
        }

        .sidebar-menu li.menu-separator {
            margin-top: 20px;
            color: #7f8c8d;
            font-size: 0.9em;
            padding: 0 15px;
            font-weight: bold;
        }

        /* Konten Utama */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .main-content h1 {
            color: #34495e;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }
        
        /* Penambahan: Tombol Aksi Header */
        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .header-actions .form-submit-button {
            margin-top: 0;
            background-color: #27ae60; /* Warna hijau */
        }
        .header-actions .form-submit-button:hover {
            background-color: #229955;
        }


        /* Kontainer untuk setiap halaman/konten */
        .content-section {
            display: none; /* Semua disembunyikan by default */
        }
        .content-section.active {
            display: block; /* Yang aktif akan ditampilkan */
        }


        /* Styling untuk Tabel Data */
        .data-table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background-color: #ffffff;
        }

        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            vertical-align: top;
            white-space: nowrap;
        }

        .data-table th {
            background-color: #ecf0f1;
            color: #34495e;
            font-weight: bold;
            text-align: center;
            vertical-align: middle;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Gaya untuk sel tabel progres */
        .data-table .progres-count {
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
        }

        /* STYLING UNTUK FORM (di dalam Modal dan Filter) */
        .data-form {
            background-color: #ffffff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .modal-content .data-form {
            margin-top: 0;
            padding: 0;
            box-shadow: none;
            text-align: left;
        }
        
        .data-form h3 {
            color: #2c3e50;
            border-bottom: 1px solid #ecf0f1;
            padding-bottom: 10px;
            margin-top: 20px;
        }
        .data-form h3:first-child {
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .form-group-grid .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group input[type="password"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #fff;
        }
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        .form-submit-button {
            background-color: #2c3e50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .form-submit-button:hover {
            background-color: #34495e;
        }
        .form-submit-button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .form-action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }
        .btn-cancel {
            background-color: #7f8c8d;
        }
        .btn-cancel:hover {
            background-color: #95a5a6;
        }


        /* Tombol Aksi di Tabel */
        .btn-edit, .btn-delete {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        .btn-edit {
            background-color: #3498db;
        }
        .btn-edit:hover {
            background-color: #2980b9;
        }
        .btn-delete {
            background-color: #e74c3c;
        }
        .btn-delete:hover {
            background-color: #c0392b;
        }
        .btn-confirm-delete {
            background-color: #e74c3c;
        }
        .btn-confirm-delete:hover {
            background-color: #c0392b;
        }

        /* ==================
           GAYA MODAL BARU
        =================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 500px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            position: relative;
        }
        .modal-content.modal-lg {
            max-width: 700px;
        }
        .modal-content.modal-sm {
            max-width: 400px;
        }
        
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-content h3 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .modal-content p {
            color: #34495e;
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .modal-content .error-message {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 15px;
            display: none;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 28px;
            font-weight: bold;
            color: #7f8c8d;
            cursor: pointer;
            transition: color 0.3s;
        }
        .modal-close:hover {
            color: #2c3e50;
        }

        .modal-content .profile-image { 
            width: 180px; 
            height: 180px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 20px;
            border: 4px solid #3498db;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative; 
        }

        .modal-content .profile-image:hover {
            transform: scale(1.5);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            z-index: 10;
        }

        /* Gaya untuk status loading */
        .loading-placeholder {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 1.2em;
        }
        .loading-placeholder i {
            margin-right: 10px;
        }

        /* ==================
           GAYA FILTER
        =================== */
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        .filter-container .form-group {
            flex: 1;
            min-width: 200px;
            margin-bottom: 0;
        }
        .filter-container select:disabled {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }
        .filter-container .form-submit-button {
            flex-shrink: 0;
            height: 40px;
            padding: 10px 20px;
            background-color: #e74c3c;
            line-height: 1;
        }
        .filter-container .form-submit-button:hover {
            background-color: #c0392b;
        }

    </style>
</head>
<body>

    <!-- ==================
         MODIFIKASI: MODAL LOGIN (BUKAN PASSWORD)
    =================== -->
    <div id="modal-login" class="modal-overlay active">
        <div class="modal-content modal-sm">
            <h3>Login Admin</h3>
            <p>Hanya role 'admin' yang dapat mengakses halaman ini.</p>
            
            <form id="login-form" class="data-form">
                <div class="form-group">
                    <label for="username-input">Username</label>
                    <input type="text" id="username-input" required>
                </div>
                <div class="form-group">
                    <label for="password-input">Password</label>
                    <input type="password" id="password-input" required>
                </div>
                <button type="submit" id="login-button" class="form-submit-button" style="width: 100%;">Login</button>
                <p id="login-error" class="error-message">Username atau password salah.</p>
            </form>
        </div>
    </div>


    <div class="app-container" id="app-container">
        
        <!-- ==================
             SIDEBAR (MENU)
        =================== -->
        <aside class="sidebar">
            <h2 id="sidebar-title">LITNUM (ADMIN)</h2>
            <ul class="sidebar-menu">
                <!-- PENYESUAIAN: Progres menjadi default, Lokus tidak lagi default -->
                <li><a data-target="content-progres" class="active">Progres</a></li>      
                <li><a data-target="content-lokus">Data Lokus</a></li>
                <li><a data-target="content-sekolah">Data Sekolah</a></li>
                <li><a data-target="content-manajemen-user">Manajemen User</a></li>
                
                <!-- BARU: Menu Database -->
                <li><a data-target="content-database">Database</a></li>
                
                <li><a href="#" class="show-modal">Laporan</a></li>
                
                <li class="menu-separator">ROLE LAIN</li>
                <li><a href="#" class="show-modal">Halaman Petugas</a></li>
                <li><a href="#" class="show-modal">Halaman Supervisor</a></li>

                <!-- MODIFIKASI: Tombol Logout -->
                <li class="menu-separator" style="margin-top: 30px;">
                    <a href="#" id="logout-button" style="background-color: #c0392b; color: white;">Logout</a>
                </li>
            </ul>
        </aside>

        <!-- ==================
             KONTEN UTAMA
        =================== -->
        <main class="main-content">

            <!-- ================================== -->
            <!--   HALAMAN 1: PROGRES (Implementasi Baru) -->
            <!-- ================================== -->
            <div id="content-progres" class="content-section active">
                <h1>Progres Pekerjaan (per Kab/Kota)</h1>
                <p>Menampilkan jumlah form yang telah di-submit oleh petugas di setiap lokus (Kab/Kota).</p>
                <p>Data diperbarui secara real-time.</p>

                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Kab/Kota</th>
                                <th>Provinsi</th>
                                <th>FGD</th>
                                <th>Wawancara Guru</th>
                                <th>Observasi</th>
                                <th>Wawancara Murid</th>
                                <th>Laporan</th>
                            </tr>
                        </thead>
                        <tbody id="progres-tbody">
                            <tr>
                                <td colspan="8" class="loading-placeholder">
                                    <i class="fas fa-spinner fa-spin"></i> Memuat data progres...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div> <!-- Penutup #content-progres -->

            <!-- ================================== -->
            <!--   HALAMAN 2: DATA LOKUS -->
            <!-- ================================== -->
            <!-- PENYESUAIAN: class="active" dihapus -->
            <div id="content-lokus" class="content-section">
                <h1>Data Lokus Monitoring</h1>
                <p>Data lokus sekolah yang akan di-monev oleh petugas. Gunakan filter di bawah untuk mencari data lokus.</p>

                <div class="filter-container data-form">
                    <div class="form-group">
                        <label for="lokus-filter-provinsi">Provinsi</label>
                        <select id="lokus-filter-provinsi">
                            <option value="">Semua Provinsi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="lokus-filter-kabkota">Kab/Kota</label>
                        <select id="lokus-filter-kabkota" disabled>
                            <option value="">Semua Kab/Kota</option>
                        </select>
                    </div>
                    <button id="lokus-reset-filter" class="form-submit-button">Reset</button>
                </div>

                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th rowspan="2">No</th>
                                <th rowspan="2">Provinsi</th>
                                <th rowspan="2">Kab/Kota</th>
                                <th colspan="2">Sekolah 1</th>
                                <th colspan="2">Sekolah 2</th>
                                <th colspan="2">Petugas 1</th>
                                <th colspan="2">Petugas 2</th>
                                <th rowspan="2">Username</th>
                                <th rowspan="2">Password</th>
                                <th rowspan="2">Aksi</th>
                            </tr>
                            <tr>
                                <th>NPSN</th>
                                <th>Nama Sekolah</th>
                                <th>NPSN</th>
                                <th>Nama Sekolah</th>
                                <th>Nama</th>
                                <th>Kontak</th>
                                <th>Nama</th>
                                <th>Kontak</th>
                            </tr>
                        </thead>
                        <tbody id="lokus-tbody">
                            <tr>
                                <td colspan="13" class="loading-placeholder">
                                    <i class="fas fa-spinner fa-spin"></i> Memuat data lokus...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div> <!-- Penutup #content-lokus -->

            <!-- ================================== -->
            <!--      HALAMAN 3: TABEL SEKOLAH      -->
            <!-- ================================== -->
            <div id="content-sekolah" class="content-section">
                <h1>Data Master Sekolah</h1>
                <p>Daftar semua sekolah yang terdaftar dalam sistem. Gunakan filter di bawah untuk mencari data sekolah.</p>
                
                <div class="filter-container data-form">
                    <div class="form-group">
                        <label for="filter-provinsi">Provinsi</label>
                        <select id="filter-provinsi">
                            <option value="">Semua Provinsi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-kabkota">Kab/Kota</label>
                        <select id="filter-kabkota" disabled>
                            <option value="">Semua Kab/Kota</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-sekolah">Sekolah (NPSN)</label>
                        <select id="filter-sekolah" disabled>
                            <option value="">Semua Sekolah</option>
                        </select>
                    </div>
                    <button id="reset-filter" class="form-submit-button">Reset</button>
                </div>

                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>NPSN</th>
                                <th>Nama Sekolah</th>
                                <th>Provinsi</th>
                                <th>Kab/Kota</th>
                                <th>Petugas 1</th>
                                <th>Petugas 2</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="sekolah-tbody">
                            <tr>
                                <td colspan="8" class="loading-placeholder">
                                    <i class="fas fa-spinner fa-spin"></i> Memuat data sekolah...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div> <!-- Penutup #content-sekolah -->

            <!-- ================================== -->
            <!--   HALAMAN 4: MANAJEMEN USER -->
            <!-- ================================== -->
            <div id="content-manajemen-user" class="content-section">
                <div class="header-actions">
                    <h1>Manajemen User</h1>
                    <button class="form-submit-button" id="btn-show-add-user">
                        <i class="fas fa-plus"></i> Tambah User Baru
                    </button>
                </div>
                <p>Kelola akun yang dapat login ke sistem (Admin, Supervisor, Petugas).</p>

                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Username</th>
                                <th>Password</th>
                                <th>Kab/Kota</th>
                                <th>Role</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="user-tbody">
                            <tr>
                                <td colspan="6" class="loading-placeholder">
                                    <i class="fas fa-spinner fa-spin"></i> Memuat data user...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div> <!-- Penutup #content-manajemen-user -->
            
            <!-- ================================== -->
            <!--   BARU: HALAMAN 5: DATABASE -->
            <!-- ================================== -->
            <div id="content-database" class="content-section">
                <h1>Manajemen Database</h1>
                <p>Fungsi untuk mengelola data master dan mereset progres. Gunakan dengan hati-hati.</p>

                <!-- Reset Data Input -->
                <div class="data-form" style="border-left: 4px solid #e74c3c; margin-top: 20px;">
                    <h3>Reset Data Input</h3>
                    <p>Ini akan <strong>MENGHAPUS SEMUA</strong> data input (FGD, Wawancara, Observasi, Laporan) dari database. Data 'sekolah' dan 'users' akan tetap ada.</p>
                    <button id="btn-reset-data" class="form-submit-button" style="background-color: #e74c3c;">Reset Data Input Sekarang</button>
                </div>

                <!-- Restore Data Default -->
                <div class="data-form" style="margin-top: 20px; border-left: 4px solid #f39c12;">
                    <h3>Restore Data Default</h3>
                    <p>Ini akan <strong>MENGHAPUS SEMUA</strong> data 'sekolah' dan 'users' yang ada, lalu mengisinya kembali dengan data default (sama seperti SetDatabase.html). Data input (FGD, Laporan, dll) TIDAK akan terhapus.</p>
                    <button id="btn-restore-default" class="form-submit-button" style="background-color: #f39c12;">Restore Data Default 'Sekolah' & 'Users'</button>
                </div>
                
                <!-- Info Backup Manual -->
                <div class="data-form" style="margin-top: 20px; border-left: 4px solid #3498db;">
                    <h3>Backup & Restore Manual</h3>
                    <p>Fitur Backup (Export) dan Restore (Import) penuh tidak dapat dilakukan dari sisi klien (browser). Harap gunakan konsol Google Cloud Firebase untuk melakukan ekspor/impor data penuh.</p>
                </div>
            </div> <!-- Penutup #content-database -->
            

        </main>
    </div>

    <!-- ==================
         MODAL "COMING SOON"
    =================== -->
    <div id="soon-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <img src="https://placehold.co/180x180/3498db/ffffff?text=Admin&font=play" alt="Admin Sibuk" class="profile-image">
            <h3>Mohon Maaf</h3>
            <p>Halaman akan segera terbit.</p>
        </div>
    </div>

    <!-- ==================
         MODAL EDIT SEKOLAH
    =================== -->
    <div id="modal-edit-sekolah" class="modal-overlay">
        <div class="modal-content modal-lg">
            <button class="modal-close">&times;</button>
            <h3>Edit Data Sekolah</h3>
            
            <form id="form-edit-sekolah" class="data-form">
                <input type="hidden" id="edit-sekolah-id">
                <div class="form-group-grid">
                    <div class="form-group">
                        <label for="edit-npsn">NPSN</label>
                        <input type="text" id="edit-npsn" placeholder="Contoh: 12345678" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-sekolah-nama">Nama Sekolah</label>
                        <input type="text" id="edit-sekolah-nama" placeholder="Contoh: SDN 1 Jakarta" required>
                    </div>
                </div>
                <div class="form-group-grid">
                    <div class="form-group">
                        <label for="edit-provinsi">Provinsi</label>
                        <input type="text" id="edit-provinsi" placeholder="Contoh: DKI Jakarta" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-kota">Kab/Kota</label>
                        <input type="text" id="edit-kota" placeholder="Contoh: Kota Jakarta Pusat" required>
                    </div>
                </div>
                <div class="form-group-grid">
                    <div class="form-group">
                        <label for="edit-petugas1">Petugas 1</label>
                        <input type="text" id="edit-petugas1" placeholder="Nama Petugas 1 (No. HP)">
                    </div>
                    <div class="form-group">
                        <label for="edit-petugas2">Petugas 2</label>
                        <input type="text" id="edit-petugas2" placeholder="Nama Petugas 2 (No. HP)">
                    </div>
                </div>
                <div class="form-action-buttons">
                    <button type="button" class="form-submit-button btn-cancel modal-close">Batal</button>
                    <button type="submit" id="btn-save-sekolah" class="form-submit-button">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ==================
         PENAMBAHAN: MODAL TAMBAH/EDIT USER
    =================== -->
    <div id="modal-user" class="modal-overlay">
        <div class="modal-content modal-lg">
            <button class="modal-close">&times;</button>
            <h3 id="modal-user-title">Tambah User Baru</h3>
            
            <form id="form-user" class="data-form">
                <input type="hidden" id="user-id">
                <div class="form-group">
                    <label for="user-username">Username</label>
                    <input type="text" id="user-username" required>
                </div>
                <div class="form-group">
                    <label for="user-password">Password</label>
                    <input type="text" id="user-password" required>
                </div>
                <div class="form-group">
                    <label for="user-kota">Kab/Kota (Kosongkan jika Admin/Supervisor)</label>
                    <input type="text" id="user-kota" placeholder="Contoh: Kota Bandung">
                </div>
                <div class="form-group">
                    <label for="user-role">Role</label>
                    <select id="user-role" required>
                        <option value="petugas">Petugas</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>

                <div class="form-action-buttons">
                    <button type="button" class="form-submit-button btn-cancel modal-close">Batal</button>
                    <button type="submit" id="btn-save-user" class="form-submit-button">Simpan</button>
                </div>
            </form>
        </div>
    </div>


    <!-- ==================
         MODAL KONFIRMASI HAPUS
    =================== -->
    <div id="modal-confirm-delete" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h3 id="delete-confirm-title">Konfirmasi Hapus</h3>
            <p id="delete-confirm-message">Apakah Anda yakin ingin menghapus data ini? Tindakan ini tidak dapat dibatalkan.</p>
            <div class="form-action-buttons" style="justify-content: center;">
                <button type="button" class="form-submit-button btn-cancel modal-close">Batal</button>
                <button type="button" id="delete-confirm-button" class="form-submit-button btn-confirm-delete">Ya, Hapus</button>
            </div>
        </div>
    </div>


    <!-- ==================
         JAVASCRIPT
    =================== -->

    <script type="module">
        // 1. Impor modul Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, collection, setLogLevel,
            onSnapshot, doc, updateDoc, deleteDoc, writeBatch, query, where, getDocs,
            addDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 2. Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDxH9Do9ecrEHW8sNxfpGjLUQ3qP14ONGM",
            authDomain: "litnum2025.firebaseapp.com",
            projectId: "litnum2025",
            storageBucket: "litnum2025.firebasestorage.app",
            messagingSenderId: "233586560867",
            appId: "1:233586560867:web:2800372b3a62dde68a8d56"
        };
        
        // ========================================================
        // BARU: DATA DEFAULT UNTUK FUNGSI RESTORE
        // (Diambil dari SetDatabase.html)
        // ========================================================
        const dataSekolah = [
            // Prov. Sumatera Utara
            { npsn: '10210587', sekolah: 'UPT SD NEGERI 060804', provinsi: 'Prov. Sumatera Utara', kota: 'Kota Medan', petugas1: 'Asmaniar Sinaga', petugas2: 'Faujiah Marlina' },
            { npsn: '10210176', sekolah: 'UPT SD NEGERI 066655', provinsi: 'Prov. Sumatera Utara', kota: 'Kota Medan', petugas1: 'Asmaniar Sinaga', petugas2: 'Faujiah Marlina' },
            // Prov. Sumatera Barat
            { npsn: '10304135', sekolah: 'SD NEGERI 38 SEBERANG PD. SELATAN', provinsi: 'Prov. Sumatera Barat', kota: 'Kota Padang', petugas1: 'Rahmat Hidayat', petugas2: 'Fakhriza Akbar' },
            { npsn: '10304454', sekolah: 'SD NEGERI 06 PIAI TENGAH', provinsi: 'Prov. Sumatera Barat', kota: 'Kota Padang', petugas1: 'Rahmat Hidayat', petugas2: 'Fakhriza Akbar' },
            // Prov. Lampung
            { npsn: '10810488', sekolah: 'SDN 2 BANDAR DALAM', provinsi: 'Prov. Lampung', kota: 'Kab. Lampung Selatan', petugas1: 'Heri Fitriono', petugas2: 'Yanto Musthofa' },
            { npsn: '10800301', sekolah: 'SDN 2 SUKAMARGA', provinsi: 'Prov. Lampung', kota: 'Kab. Lampung Selatan', petugas1: 'Heri Fitriono', petugas2: 'Yanto Musthofa' },
            // Prov. Banten
            { npsn: '20602929', sekolah: 'SD NEGERI KEDAUNG I', provinsi: 'Prov. Banten', kota: 'Kab. Tangerang', petugas1: 'Muhammad Noor Ginanjar Jaelani', petugas2: 'Billy Antoro' },
            { npsn: '20603480', sekolah: 'SD NEGERI SETIA BHAKTI', provinsi: 'Prov. Banten', kota: 'Kab. Tangerang', petugas1: 'Muhammad Noor Ginanjar Jaelani', petugas2: 'Billy Antoro' },
            // Prov. Jawa Barat - Kota Bogor
            { npsn: '20238443', sekolah: 'SD NEGERI CILENDEK TIMUR 2', provinsi: 'Prov. Jawa Barat', kota: 'Kota Bogor', petugas1: 'Lanny Anggraini', petugas2: 'Rossi Marinjani' },
            { npsn: '20220537', sekolah: 'SD NEGERI SITU GEDE 1', provinsi: 'Prov. Jawa Barat', kota: 'Kota Bogor', petugas1: 'Lanny Anggraini', petugas2: 'Rossi Marinjani' },
            // Prov. Jawa Barat - Kota Bandung
            { npsn: '20245797', sekolah: 'SDN 160 SUKALAKSANA', provinsi: 'Prov. Jawa Barat', kota: 'Kota Bandung', petugas1: 'Ine Rahmawati', petugas2: 'Sofie Dewayani' },
            { npsn: '20245731', sekolah: 'SDN 253 PANGGUNGSARI', provinsi: 'Prov. Jawa Barat', kota: 'Kota Bandung', petugas1: 'Ine Rahmawati', petugas2: 'Sofie Dewayani' },
            // Prov. Jawa Barat - Kab. Bekasi
            { npsn: '20245341', sekolah: 'SD NEGERI KARANG REJA 01', provinsi: 'Prov. Jawa Barat', kota: 'Kab. Bekasi', petugas1: 'Dwi Nurani', petugas2: 'Roosie Setiawan' },
            { npsn: '20218584', sekolah: 'SD NEGERI SUKAMURNI 02', provinsi: 'Prov. Jawa Barat', kota: 'Kab. Bekasi', petugas1: 'Dwi Nurani', petugas2: 'Roosie Setiawan' },
            // Prov. Jawa Tengah - Kab. Sukoharjo
            { npsn: '20330782', sekolah: 'SD NEGERI WIRONANGGAN 02', provinsi: 'Prov. Jawa Tengah', kota: 'Kab. Sukoharjo', petugas1: 'Auwalia Ramadhani', petugas2: 'Riski' },
            { npsn: '20310486', sekolah: 'SD NEGERI PUCANGAN 06', provinsi: 'Prov. Jawa Tengah', kota: 'Kab. Sukoharjo', petugas1: 'Auwalia Ramadhani', petugas2: 'Riski' },
            // Prov. Jawa Tengah - Kab. Karanganyar
            { npsn: '20312197', sekolah: 'SDN 06 TAWANGMANGU', provinsi: 'Prov. Jawa Tengah', kota: 'Kab. Karanganyar', petugas1: 'Anggia Sabrina', petugas2: 'Dewi Liyana Katili (081289933075)' },
            { npsn: '20311911', sekolah: 'SDN 03 JATISUKO', provinsi: 'Prov. Jawa Tengah', kota: 'Kab. Karanganyar', petugas1: 'Anggia Sabrina', petugas2: 'Dewi Liyana Katili (081289933075)' },
            // Prov. D.I. Yogyakarta
            { npsn: '20402548', sekolah: 'SD GETAS II', provinsi: 'Prov. D.I. Yogyakarta', kota: 'Kab. Gunung Kidul', petugas1: 'Amala Sholiha', petugas2: 'Andry Novi' },
            { npsn: '20401741', sekolah: 'SD SEMIN III SEMIN', provinsi: 'Prov. D.I. Yogyakarta', kota: 'Kab. Gunung Kidul', petugas1: 'Amala Sholiha', petugas2: 'Andry Novi' },
            // Prov. Jawa Timur - Kota Surabaya
            { npsn: '20533175', sekolah: 'SDN PEGIRIAN I / 47', provinsi: 'Prov. Jawa Timur', kota: 'Kota Surabaya', petugas1: 'R. Mitra Irianarya', petugas2: 'Dicky Susanto' },
            { npsn: '20533538', sekolah: 'SDN KREMBANGAN SELATAN IX NO. 20', provinsi: 'Prov. Jawa Timur', kota: 'Kota Surabaya', petugas1: 'R. Mitra Irianarya', petugas2: 'Dicky Susanto' },
            // Prov. Jawa Timur - Kab. Banyuwangi
            { npsn: '20525398', sekolah: 'SDN 2 TEGALREJO', provinsi: 'Prov. Jawa Timur', kota: 'Kab. Banyuwangi', petugas1: 'Enfira Yanuaristi', petugas2: 'Mita Hidayati (085921430783)' },
            { npsn: '20525883', sekolah: 'SDN 8 SUMBERBERAS', provinsi: 'Prov. Jawa Timur', kota: 'Kab. Banyuwangi', petugas1: 'Enfira Yanuaristi', petugas2: 'Mita Hidayati (085921430783)' },
            // Prov. Nusa Tenggara Barat
            { npsn: '50204433', sekolah: 'SD NEGERI 36 AMPENAN', provinsi: 'Prov. Nusa Tenggara Barat', kota: 'Kota Mataram', petugas1: 'Waluyo', petugas2: 'Bintang Permana (081310051985)' },
            { npsn: '50204622', sekolah: 'SD NEGERI 23 MATARAM', provinsi: 'Prov. Nusa Tenggara Barat', kota: 'Kota Mataram', petugas1: 'Waluyo', petugas2: 'Bintang Permana (081310051985)' },
            // Prov. Nusa Tenggara Timur
            { npsn: '50306417', sekolah: 'SD NEGERI TO\'BATAN', provinsi: 'Prov. Nusa Tenggara Timur', kota: 'Kab. Kupang', petugas1: 'Citra Adi Pratiwi', petugas2: 'Namira Syahda' },
            { npsn: '50300419', sekolah: 'SD INPRES FATUKNUTU', provinsi: 'Prov. Nusa Tenggara Timur', kota: 'Kab. Kupang', petugas1: 'Citra Adi Pratiwi', petugas2: 'Namira Syahda' },
            // Prov. Kalimantan Barat
            { npsn: '30101481', sekolah: 'SD NEGERI 9 SUNGAI AMBAWANG', provinsi: 'Prov. Kalimantan Barat', kota: 'Kab. Kuburaya', petugas1: 'Supriyatin', petugas2: 'Dewi Puji Lestari (081212509903)' },
            { npsn: '30100783', sekolah: 'SD NEGERI 34 SUNGAI AMBAWANG', provinsi: 'Prov. Kalimantan Barat', kota: 'Kab. Kuburaya', petugas1: 'Supriyatin', petugas2: 'Dewi Puji Lestari (081212509903)' },
            // Prov. Kalimantan Tengah
            { npsn: '30203527', sekolah: 'SDN - 1 BANTURUNG', provinsi: 'Prov. Kalimantan Tengah', kota: 'Kota Palangka Raya', petugas1: 'Andi Havyana', petugas2: 'Astri Oktina Budianti (089663364467)' },
            { npsn: '30203411', sekolah: 'SDN - 3 TANGKILING', provinsi: 'Prov. Kalimantan Tengah', kota: 'Kota Palangka Raya', petugas1: 'Andi Havyana', petugas2: 'Astri Oktina Budianti (089663364467)' },
            // Prov. Sulawesi Selatan
            { npsn: '40300273', sekolah: 'SDN 37 PANAIKANG', provinsi: 'Prov. Sulawesi Selatan', kota: 'Kab. Maros', petugas1: 'Abdul Halim Muharram', petugas2: 'Yohan Rubiyantoro' },
            { npsn: '69858811', sekolah: 'SDN 245 CABBELLA', provinsi: 'Prov. Sulawesi Selatan', kota: 'Kab. Maros', petugas1: 'Abdul Halim Muharram', petugas2: 'Yohan Rubiyantoro' },
            // Prov. Gorontalo
            { npsn: '40501379', sekolah: 'SD NEGERI NO. 45 DUMBO RAYA', provinsi: 'Prov. Gorontalo', kota: 'Kota Gorontalo', petugas1: 'Noor Cahyo Kiki', petugas2: 'Irfandha Fatan (‪081311031067‬)' },
            { npsn: '40501362', sekolah: 'SD NEGERI NO. 44 HULONTALANGI', provinsi: 'Prov. Gorontalo', kota: 'Kota Gorontalo', petugas1: 'Noor Cahyo Kiki', petugas2: 'Irfandha Fatan (‪081311031067‬)' },
            // Prov. Papua
            { npsn: '60301127', sekolah: 'SD NEGERI INPRES ARDIPURA I', provinsi: 'Prov. Papua', kota: 'Kota Jayapura', petugas1: 'Deni Komarudin (082126011609)', petugas2: 'Ronald Stevanus (081281225788)' },
            { npsn: '60301130', sekolah: 'SD NEGERI INPRES BHAYANGKARA', provinsi: 'Prov. Papua', kota: 'Kota Jayapura', petugas1: 'Deni Komarudin (082126011609)', petugas2: 'Ronald Stevanus (081281225788)' },
            // Prov. Jawa Timur - Kab. Malang
            { npsn: '20518538', sekolah: 'SDN 2 LANDUNGSARI', provinsi: 'Prov. Jawa Timur', kota: 'Kab. Malang', petugas1: 'Sri Widyowati Kinasih', petugas2: 'Wily Ariwiguna' },
            { npsn: '20576079', sekolah: 'SD NEGERI 3 BANJAREJO', provinsi: 'Prov. Jawa Timur', kota: 'Kab. Malang', petugas1: 'Sri Widyowati Kinasih', petugas2: 'Wily Ariwiguna' },
        ];
        
        // Buat daftar user dari data sekolah
        const uniqueRegions = new Map();
        dataSekolah.forEach(sekolah => {
            const username = sekolah.kota.replace(/ /g, ''); // "Kota Medan" -> "KotaMedan"
            if (!uniqueRegions.has(username)) {
                uniqueRegions.set(username, {
                    kota: sekolah.kota,
                    provinsi: sekolah.provinsi
                });
            }
        });
        const dataUsers = [];
        uniqueRegions.forEach((region, username) => {
            dataUsers.push({
                username: username,
                password: "1234",
                kota: region.kota,
                provinsi: region.provinsi,
                role: "petugas" // Tambahkan role default
            });
        });
        dataUsers.push({
            username: "Admin",
            password: "Admin123",
            kota: "ADMINISTRATOR",
            provinsi: "ADMINISTRATOR",
            role: "admin"
        });
        // ========================================================
        // AKHIR DARI DATA DEFAULT
        // ========================================================

        // 3. Inisialisasi Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            setLogLevel('debug');
            console.log("Firebase berhasil diinisialisasi untuk Admin.html.");
        } catch (e) {
            console.error("Error inisialisasi Firebase:", e);
        }

        // --- Variabel Global untuk menyimpan data ---
        let allSekolahList = [];
        let allUsersList = [];
        // BARU: Daftar koleksi data input
        const dataCollections = ['fgd', 'wawancara_guru', 'observasi', 'wawancara_murid', 'laporan'];

        // --- Variabel Global untuk Modal ---
        const editSekolahModal = document.getElementById('modal-edit-sekolah');
        const editSekolahForm = document.getElementById('form-edit-sekolah');
        const btnSaveSekolah = document.getElementById('btn-save-sekolah');
        
        const deleteConfirmModal = document.getElementById('modal-confirm-delete');
        const deleteConfirmTitle = document.getElementById('delete-confirm-title');
        const deleteConfirmMessage = document.getElementById('delete-confirm-message');
        const deleteConfirmButton = document.getElementById('delete-confirm-button');
        
        const userModal = document.getElementById('modal-user');
        const userForm = document.getElementById('form-user');
        const userModalTitle = document.getElementById('modal-user-title');
        const btnSaveUser = document.getElementById('btn-save-user');
        const hiddenUserId = document.getElementById('user-id');
        
        let activeDeleteFunction = null; 

        // --- Variabel Modal Login & App Container ---
        const modalLogin = document.getElementById('modal-login');
        const loginForm = document.getElementById('login-form');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        const usernameInput = document.getElementById('username-input');
        const passwordInput = document.getElementById('password-input');
        const appContainer = document.getElementById('app-container');

        // --- FUNGSI UNTUK MENGAMBIL DATA (REAL-TIME) ---

        function setupSekolahListener() {
            const sekolahCol = collection(db, "sekolah");
            onSnapshot(sekolahCol, (snapshot) => {
                console.log("Data sekolah diperbarui (onSnapshot)...");
                allSekolahList = snapshot.docs.map(doc => ({ 
                    id: doc.id,
                    ...doc.data() 
                }));
                allSekolahList.sort((a, b) => (a.provinsi || "").localeCompare(b.provinsi || "") || (a.kota || "").localeCompare(b.kota || ""));
                handleDataUpdate();
            }, (error) => {
                console.error("Error listening to sekolah collection:", error);
            });
        }

        function setupUsersListener() {
            const usersCol = collection(db, "users");
            onSnapshot(usersCol, (snapshot) => {
                console.log("Data users diperbarui (onSnapshot)...");
                allUsersList = snapshot.docs.map(doc => ({ 
                    id: doc.id,
                    ...doc.data() 
                }));
                allUsersList.sort((a, b) => (a.username || "").localeCompare(b.username || ""));
                handleDataUpdate();
            }, (error) => {
                console.error("Error listening to users collection:", error);
            });
        }
        
        // BARU: Listener untuk semua koleksi data (FGD, Laporan, dll)
        function setupDataListeners() {
            dataCollections.forEach(colName => {
                onSnapshot(collection(db, colName), (snapshot) => {
                    console.log(`Data ${colName} diperbarui... Muat ulang progres.`);
                    // Cukup panggil loadProgressData, tidak perlu panggil handleDataUpdate penuh
                    loadProgressData();
                }, (error) => {
                    console.error(`Error listening to ${colName}:`, error);
                });
            });
        }

        function handleDataUpdate() {
            // Cek jika filter-provinsi ada (mungkin belum di-load jika user belum login)
            if (!document.getElementById('filter-provinsi')) return;

            // Simpan nilai filter yang sedang aktif
            const lokusProvVal = document.getElementById('lokus-filter-provinsi').value;
            const lokusKabVal = document.getElementById('lokus-filter-kabkota').value;
            const sekolahProvVal = document.getElementById('filter-provinsi').value;
            const sekolahKabVal = document.getElementById('filter-kabkota').value;
            const sekolahNpsnVal = document.getElementById('filter-sekolah').value;

            // Update dropdown filter (jika ada data baru)
            populateProvinsiFilter(allSekolahList, document.getElementById('lokus-filter-provinsi'));
            populateProvinsiFilter(allSekolahList, document.getElementById('filter-provinsi'));
            
            updateDependentFilters('lokus-filter-provinsi', 'lokus-filter-kabkota', null);
            updateDependentFilters('filter-provinsi', 'filter-kabkota', 'filter-sekolah');

            // Kembalikan nilai filter yang tadi aktif
            document.getElementById('lokus-filter-provinsi').value = lokusProvVal;
            document.getElementById('lokus-filter-kabkota').value = lokusKabVal;
            document.getElementById('filter-provinsi').value = sekolahProvVal;
            document.getElementById('filter-kabkota').value = sekolahKabVal;
            document.getElementById('filter-sekolah').value = sekolahNpsnVal;

            // Render ulang tabel berdasarkan filter yang aktif
            filterLokusTabel();
            filterSekolahTabel();
            renderUserTable(allUsersList); // Render tabel user
            
            // BARU: Muat ulang progres karena data user (lokus) mungkin berubah
            loadProgressData();
        }


        // --- FUNGSI UNTUK MERENDER TABEL ---

        // BARU: Fungsi untuk memuat dan merender tabel progres
        async function loadProgressData() {
            const progresTbody = document.getElementById('progres-tbody');
            if (!progresTbody) return;

            progresTbody.innerHTML = `<tr><td colspan="8" class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Menghitung progres...</td></tr>`;

            try {
                // 1. Buat PETA NPSN -> KOTA (Ini adalah KUNCI perbaikan)
                // Kita asumsikan allSekolahList sudah terisi dari onSnapshot
                const npsnToKotaMap = new Map();
                allSekolahList.forEach(sekolah => {
                    if (sekolah.npsn) {
                        npsnToKotaMap.set(sekolah.npsn, sekolah.kota);
                    }
                });

                // 2. Dapatkan daftar lokus (Kab/Kota & Provinsi) dari data 'users' (petugas)
                const lokusList = allUsersList
                    .filter(u => u.role === 'petugas' || (u.kota && u.kota !== 'ADMINISTRATOR'))
                    .map(u => ({ 
                        kota: u.kota, 
                        provinsi: u.provinsi || '-', 
                        // Inisialisasi hitungan
                        ...dataCollections.reduce((acc, col) => ({...acc, [col]: 0}), {}) 
                    }));
                
                // Gunakan Map untuk pencarian cepat berdasarkan NAMA KOTA
                const lokusMap = new Map(lokusList.map(l => [l.kota, l])); // Key: "Kota Medan"

                // 3. Fetch semua data input dan hitung
                const fetchPromises = dataCollections.map(async (colName) => {
                    const colRef = collection(db, colName);
                    const snapshot = await getDocs(colRef);
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        
                        // --- PERBAIKAN LOGIKA ---
                        // A. Cari NPSN di dalam data. Nama fieldnya berbeda-beda di tiap form.
                        const npsn = data.npsn || data.npsn_fgd || data.npsn_murid || data.npsn_obs || data.npsn_lpr;

                        if (npsn) {
                            // B. Cari 'kota' berdasarkan NPSN dari peta kita
                            const kota = npsnToKotaMap.get(npsn); // Misal: "Kota Medan"
                            
                            // C. Jika 'kota' ditemukan di peta NPSN DAN ada di lokusMap, hitung
                            if (kota && lokusMap.has(kota)) {
                                lokusMap.get(kota)[colName]++;
                            } else {
                                // Log ini jika data NPSN ada tapi tidak ter-map ke lokus (misal: data lama)
                                console.warn(`Data ${colName} (NPSN: ${npsn}, Kota: ${kota}) tidak ter-map ke lokus yg ada.`);
                            }
                        } else {
                            // Log ini jika data tidak punya NPSN sama sekali (seharusnya tidak terjadi)
                            console.warn(`Data ${colName} (doc ID: ${doc.id}) tidak memiliki field NPSN.`);
                        }
                        // --- AKHIR PERBAIKAN LOGIKA ---
                    });
                });

                // Tunggu semua proses hitung selesai
                await Promise.all(fetchPromises);

                // 4. Render tabel
                progresTbody.innerHTML = '';
                let counter = 1;
                
                // Urutkan berdasarkan nama kota
                const sortedLokus = [...lokusMap.values()].sort((a, b) => a.kota.localeCompare(b.kota));

                sortedLokus.forEach((lokus) => {
                    const row = `
                        <tr>
                            <td style="text-align: center;">${counter++}</td>
                            <td>${lokus.kota}</td>
                            <td>${lokus.provinsi}</td>
                            <td class="progres-count">${lokus.fgd}</td>
                            <td class="progres-count">${lokus.wawancara_guru}</td>
                            <td class="progres-count">${lokus.observasi}</td>
                            <td class="progres-count">${lokus.wawancara_murid}</td>
                            <td class="progres-count">${lokus.laporan}</td>
                        </tr>
                    `;
                    progresTbody.innerHTML += row;
                });

                if (lokusMap.size === 0) {
                    progresTbody.innerHTML = `<tr><td colspan="8" class="loading-placeholder">Tidak ada data lokus petugas ditemukan.</td></tr>`;
                }

            } catch (error) {
                console.error("Gagal memuat data progres:", error);
                progresTbody.innerHTML = `<tr><td colspan="8" class="loading-placeholder" style="color: #e74c3c;">Gagal memuat progres: ${error.message}</td></tr>`;
            }
        }


        function renderMasterSekolah(sekolahList) {
            const tbody = document.getElementById('sekolah-tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            if (sekolahList.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px;">Tidak ada data sekolah ditemukan untuk filter ini.</td></tr>`;
                return;
            }

            sekolahList.forEach((sekolah, index) => {
                const row = `
                    <tr>
                        <td style="text-align: center;">${index + 1}</td>
                        <td>${sekolah.npsn || '-'}</td>
                        <td>${sekolah.sekolah || '-'}</td>
                        <td>${sekolah.provinsi || '-'}</td>
                        <td>${sekolah.kota || '-'}</td>
                        <td>${sekolah.petugas1 || '-'}</td>
                        <td>${sekolah.petugas2 || '-'}</td>
                        <td style="text-align: center;">
                            <button class="btn-edit btn-edit-sekolah" data-id="${sekolah.id}" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn-delete btn-delete-sekolah" data-id="${sekolah.id}" title="Hapus"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function populateDataLokus(sekolahList, usersList) {
            const tbody = document.getElementById('lokus-tbody');
            if (!tbody) return;

            const userMap = new Map();
            usersList.forEach(user => {
                userMap.set(user.kota, user); 
            });

            const lokusMap = new Map();
            sekolahList.forEach(sekolah => {
                if (!lokusMap.has(sekolah.kota)) {
                    lokusMap.set(sekolah.kota, {
                        provinsi: sekolah.provinsi,
                        kota: sekolah.kota,
                        sekolah: [],
                        petugas1: sekolah.petugas1,
                        petugas2: sekolah.petugas2
                    });
                }
                lokusMap.get(sekolah.kota).sekolah.push({
                    npsn: sekolah.npsn,
                    nama: sekolah.sekolah
                });
            });

            tbody.innerHTML = '';
            let counter = 1;
            
            if (lokusMap.size === 0) {
                 tbody.innerHTML = `<tr><td colspan="13" style="text-align: center; padding: 20px;">Tidak ada data lokus ditemukan untuk filter ini.</td></tr>`;
                return;
            }

            lokusMap.forEach((lokus) => {
                const sekolah1 = lokus.sekolah[0] || { npsn: '-', nama: '-' };
                const sekolah2 = lokus.sekolah[1] || { npsn: '-', nama: '-' };
                const user = userMap.get(lokus.kota);
                const username = user ? user.username : '-';
                const password = user ? user.password : '-';
                const [namaPetugas1, kontakPetugas1] = pisahNamaDanKontak(lokus.petugas1);
                const [namaPetugas2, kontakPetugas2] = pisahNamaDanKontak(lokus.petugas2);

                const row = `
                    <tr>
                        <td style="text-align: center;">${counter++}</td>
                        <td>${lokus.provinsi}</td>
                        <td>${lokus.kota}</td>
                        <td>${sekolah1.npsn}</td>
                        <td>${sekolah1.nama}</td>
                        <td>${sekolah2.npsn}</td>
                        <td>${sekolah2.nama}</td>
                        <td>${namaPetugas1}</td>
                        <td>${kontakPetugas1}</td>
                        <td>${namaPetugas2}</td>
                        <td>${kontakPetugas2}</td>
                        <td>${username}</td>
                        <td>${password}</td>
                        <td style="text-align: center;">
                            <button class="btn-delete btn-delete-lokus" data-kota="${lokus.kota}" title="Hapus Lokus Ini"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        function renderUserTable(usersList) {
            const tbody = document.getElementById('user-tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            if (usersList.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px;">Belum ada data user.</td></tr>`;
                return;
            }

            usersList.forEach((user, index) => {
                const row = `
                    <tr>
                        <td style="text-align: center;">${index + 1}</td>
                        <td>${user.username || '-'}</td>
                        <td>${user.password || '-'}</td>
                        <td>${user.kota || '-'}</td>
                        <td>${user.role || 'petugas'}</td>
                        <td style="text-align: center;">
                            <button class="btn-edit btn-edit-user" data-id="${user.id}" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn-delete btn-delete-user" data-id="${user.id}" title="Hapus"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }


        function pisahNamaDanKontak(teks) {
            if (!teks) return ['-', '-'];
            const match = teks.match(/^(.*?)\s*(\(.*\)|08\d{8,})$/);
            if (match) {
                return [match[1].trim(), match[2].trim()];
            }
            return [teks, '-'];
        }


        // --- FUNGSI-FUNGSI FILTER ---

        function filterLokusTabel() {
            const selectedProvinsi = document.getElementById('lokus-filter-provinsi').value;
            const selectedKabKota = document.getElementById('lokus-filter-kabkota').value;
            let filteredList = [...allSekolahList];
            if (selectedProvinsi) {
                filteredList = filteredList.filter(s => s.provinsi === selectedProvinsi);
            }
            if (selectedKabKota) {
                filteredList = filteredList.filter(s => s.kota === selectedKabKota);
            }
            populateDataLokus(filteredList, allUsersList);
        }

        function filterSekolahTabel() {
            const selectedProvinsi = document.getElementById('filter-provinsi').value;
            const selectedKabKota = document.getElementById('filter-kabkota').value;
            const selectedNPSN = document.getElementById('filter-sekolah').value;
            let filteredList = [...allSekolahList];
            if (selectedProvinsi) {
                filteredList = filteredList.filter(s => s.provinsi === selectedProvinsi);
            }
            if (selectedKabKota) {
                filteredList = filteredList.filter(s => s.kota === selectedKabKota);
            }
            if (selectedNPSN) {
                filteredList = filteredList.filter(s => s.npsn === selectedNPSN);
            }
            renderMasterSekolah(filteredList);
        }

        function populateProvinsiFilter(sekolahList, selectElement) {
            if (!selectElement) return;
            const provinsiSet = new Set(sekolahList.map(s => s.provinsi).filter(Boolean));
            const sortedProvinsi = [...provinsiSet].sort();
            
            const selectedValue = selectElement.value;
            
            selectElement.innerHTML = '<option value="">Semua Provinsi</option>';
            sortedProvinsi.forEach(prov => {
                selectElement.innerHTML += `<option value="${prov}">${prov}</option>`;
            });

            selectElement.value = selectedValue;
        }

        function updateDependentFilters(provId, kabId, npsnId) {
            const selectedProvinsi = document.getElementById(provId).value;
            const kabSelect = document.getElementById(kabId);
            const kabValue = kabSelect.value; 

            kabSelect.innerHTML = '<option value="">Semua Kab/Kota</option>';
            if (selectedProvinsi) {
                const kabKotaSet = new Set(allSekolahList
                    .filter(s => s.provinsi === selectedProvinsi)
                    .map(s => s.kota).filter(Boolean));
                [...kabKotaSet].sort().forEach(kota => {
                    kabSelect.innerHTML += `<option value="${kota}">${kota}</option>`;
                });
                kabSelect.disabled = false;
                kabSelect.value = kabValue;
            } else {
                kabSelect.disabled = true;
            }

            if (npsnId) {
                const npsnSelect = document.getElementById(npsnId);
                const npsnValue = npsnSelect.value;
                const selectedKabKota = kabSelect.value;
                
                npsnSelect.innerHTML = '<option value="">Semua Sekolah</option>';
                if (selectedKabKota) {
                    const sekolahSet = allSekolahList.filter(s => s.provinsi === selectedProvinsi && s.kota === selectedKabKota).filter(Boolean);
                    sekolahSet.sort((a, b) => (a.sekolah || "").localeCompare(b.sekolah || "")).forEach(sekolah => {
                        npsnSelect.innerHTML += `<option value="${sekolah.npsn}">${sekolah.sekolah} (${sekolah.npsn})</option>`;
                    });
                    npsnSelect.disabled = false;
                    npsnSelect.value = npsnValue;
                } else {
                    npsnSelect.disabled = true;
                }
            }
        }

        function setupLokusFilterListeners() {
            const filterProvinsi = document.getElementById('lokus-filter-provinsi');
            const filterKabKota = document.getElementById('lokus-filter-kabkota');
            const resetBtn = document.getElementById('lokus-reset-filter');

            filterProvinsi.addEventListener('change', () => {
                updateDependentFilters('lokus-filter-provinsi', 'lokus-filter-kabkota', null);
                filterLokusTabel();
            });
            filterKabKota.addEventListener('change', () => {
                filterLokusTabel();
            });
            resetBtn.addEventListener('click', () => {
                filterProvinsi.value = "";
                filterKabKota.innerHTML = '<option value="">Semua Kab/Kota</option>';
                filterKabKota.disabled = true;
                filterLokusTabel();
            });
        }

        function setupSekolahFilterListeners() {
            const filterProvinsi = document.getElementById('filter-provinsi');
            const filterKabKota = document.getElementById('filter-kabkota');
            const filterSekolah = document.getElementById('filter-sekolah');
            const resetBtn = document.getElementById('reset-filter');

            filterProvinsi.addEventListener('change', () => {
                updateDependentFilters('filter-provinsi', 'filter-kabkota', 'filter-sekolah');
                filterSekolahTabel();
            });
            filterKabKota.addEventListener('change', () => {
                updateDependentFilters('filter-provinsi', 'filter-kabkota', 'filter-sekolah');
                filterSekolahTabel();
            });
            filterSekolah.addEventListener('change', () => {
                filterSekolahTabel();
            });
            resetBtn.addEventListener('click', () => {
                filterProvinsi.value = "";
                filterKabKota.innerHTML = '<option value="">Semua Kab/Kota</option>';
                filterKabKota.disabled = true;
                filterSekolah.innerHTML = '<option value="">Semua Sekolah</option>';
                filterSekolah.disabled = true;
                filterSekolahTabel();
            });
        }

        // --- BARU: FUNGSI UNTUK MANAJEMEN DATABASE ---

        /**
         * Menampilkan modal konfirmasi untuk mereset data input.
         */
        function showResetDataConfirm() {
            deleteConfirmTitle.textContent = "Konfirmasi Reset Data Input";
            deleteConfirmMessage.innerHTML = "YAKIN ingin menghapus <strong>SEMUA</strong> data input (FGD, Laporan, Observasi, Wawancara)?<br>Tindakan ini tidak bisa dibatalkan.";
            activeDeleteFunction = resetAllInputData; // Fungsi yang akan dijalankan jika dikonfirmasi
            deleteConfirmModal.classList.add('active');
        }

        /**
         * Menampilkan modal konfirmasi untuk me-restore data default.
         */
        function showRestoreDefaultConfirm() {
            deleteConfirmTitle.textContent = "Konfirmasi Restore Default";
            deleteConfirmMessage.innerHTML = "YAKIN ingin me-restore data 'sekolah' dan 'users'?<br>Ini akan <strong>MENGHAPUS</strong> data 'sekolah' dan 'users' yang ada sekarang dan menggantinya dengan data default.";
            activeDeleteFunction = restoreDefaultData; // Fungsi yang akan dijalankan jika dikonfirmasi
            deleteConfirmModal.classList.add('active');
        }
        
        /**
         * Menghapus semua dokumen dari koleksi data input.
         */
        async function resetAllInputData() {
            console.log("Mulai mereset data input...");
            
            for (const colName of dataCollections) {
                const batch = writeBatch(db);
                const q = query(collection(db, colName));
                const snapshot = await getDocs(q);
                if(snapshot.empty) {
                    console.log(`Koleksi ${colName} sudah kosong.`);
                    continue;
                }
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                console.log(`Koleksi ${colName} berhasil direset.`);
            }
            console.log("Semua data input telah direset.");
        }

        /**
         * Menghapus koleksi 'sekolah' dan 'users' lalu mengisinya dengan data default.
         */
        async function restoreDefaultData() {
            console.log("Mulai restore data default...");
            const collectionsToWipe = ['sekolah', 'users'];
            
            // 1. Hapus data lama
            for (const colName of collectionsToWipe) {
                const batch = writeBatch(db);
                const q = query(collection(db, colName));
                const snapshot = await getDocs(q);
                if(!snapshot.empty) {
                     snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    console.log(`Koleksi ${colName} lama berhasil dihapus.`);
                }
            }
            
            // 2. Tulis data baru (logic from SetDatabase.html)
            const batch = writeBatch(db);

            // Add 'sekolah' data
            dataSekolah.forEach(sekolah => {
                const sekolahDocRef = doc(db, "sekolah", sekolah.npsn);
                batch.set(sekolahDocRef, sekolah);
            });

            // Add 'users' data
            dataUsers.forEach(user => {
                const userDocRef = doc(db, "users", user.username);
                batch.set(userDocRef, user);
            });

            await batch.commit();
            console.log("Data default 'sekolah' dan 'users' berhasil direstore.");
        }


        // --- FUNGSI INISIALISASI UTAMA (Dipanggil setelah login) ---
        async function initializeAdminPanel() {
            
            // Ambil elemen menu dan modal "coming soon"
            const menuLinks = document.querySelectorAll('.sidebar-menu a');
            const contentSections = document.querySelectorAll('.content-section');
            const soonModal = document.getElementById('soon-modal');
            const allModalCloseButtons = document.querySelectorAll('.modal-close, .modal-overlay'); 
            
            // Listener untuk link menu
            menuLinks.forEach(link => {
                link.addEventListener('click', function(event) {
                    const targetId = link.getAttribute('data-target');
                    const isModalTrigger = link.classList.contains('show-modal');

                    if (isModalTrigger) {
                        event.preventDefault(); 
                        soonModal.classList.add('active'); 
                    } else if (targetId) {
                        event.preventDefault(); 
                        const targetContent = document.getElementById(targetId);
                        menuLinks.forEach(ml => ml.classList.remove('active'));
                        contentSections.forEach(cs => cs.classList.remove('active'));
                        link.classList.add('active');
                        if (targetContent) {
                            targetContent.classList.add('active');
                        }
                    }
                });
            });

            // Listener untuk menutup SEMUA modal
            allModalCloseButtons.forEach(button => {
                button.addEventListener('click', function(event) {
                    if (event.target === this || event.target.classList.contains('modal-close')) {
                        document.querySelectorAll('.modal-overlay').forEach(modal => {
                            // Jangan tutup modal login
                            if (modal.id !== 'modal-login') {
                                modal.classList.remove('active');
                            }
                        });
                        activeDeleteFunction = null;
                    }
                });
            });

            // Setup listener real-time dan filter
            setupSekolahListener();
            setupUsersListener();
            setupDataListeners(); // BARU: untuk progres
            setupLokusFilterListeners();
            setupSekolahFilterListeners();

            
            // Event Listener untuk Tombol Aksi

            // 1. Event listener untuk tombol SIMPAN di modal EDIT SEKOLAH
            editSekolahForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                btnSaveSekolah.disabled = true;
                btnSaveSekolah.textContent = "Menyimpan...";
                const docId = document.getElementById('edit-sekolah-id').value;
                const updatedData = {
                    npsn: document.getElementById('edit-npsn').value,
                    sekolah: document.getElementById('edit-sekolah-nama').value,
                    provinsi: document.getElementById('edit-provinsi').value,
                    kota: document.getElementById('edit-kota').value,
                    petugas1: document.getElementById('edit-petugas1').value,
                    petugas2: document.getElementById('edit-petugas2').value,
                };
                try {
                    await updateDoc(doc(db, "sekolah", docId), updatedData);
                    editSekolahModal.classList.remove('active');
                } catch (error) {
                    console.error("Error updating document: ", error);
                } finally {
                    btnSaveSekolah.disabled = false;
                    btnSaveSekolah.textContent = "Simpan Perubahan";
                }
            });

            // 2. Event listener untuk tombol KONFIRMASI HAPUS
            deleteConfirmButton.addEventListener('click', async () => {
                if (typeof activeDeleteFunction === 'function') {
                    deleteConfirmButton.disabled = true;
                    deleteConfirmButton.textContent = "Menghapus...";
                    try {
                        await activeDeleteFunction();
                    } catch (error) {
                        console.error("Error saat menjalankan aksi hapus: ", error);
                    } finally {
                        deleteConfirmButton.disabled = false;
                        deleteConfirmButton.textContent = "Ya, Hapus";
                        deleteConfirmModal.classList.remove('active');
                        activeDeleteFunction = null;
                    }
                }
            });

            // 3. Event delegation untuk tombol EDIT dan DELETE di tabel SEKOLAH
            document.getElementById('sekolah-tbody').addEventListener('click', (e) => {
                const editBtn = e.target.closest('.btn-edit-sekolah');
                const deleteBtn = e.target.closest('.btn-delete-sekolah');
                if (editBtn) {
                    const docId = editBtn.dataset.id;
                    const school = allSekolahList.find(s => s.id === docId);
                    if (school) {
                        document.getElementById('edit-sekolah-id').value = school.id;
                        document.getElementById('edit-npsn').value = school.npsn || '';
                        document.getElementById('edit-sekolah-nama').value = school.sekolah || '';
                        document.getElementById('edit-provinsi').value = school.provinsi || '';
                        document.getElementById('edit-kota').value = school.kota || '';
                        document.getElementById('edit-petugas1').value = school.petugas1 || '';
                        document.getElementById('edit-petugas2').value = school.petugas2 || '';
                        editSekolahModal.classList.add('active');
                    }
                }
                if (deleteBtn) {
                    const docId = deleteBtn.dataset.id;
                    const school = allSekolahList.find(s => s.id === docId);
                    if (school) {
                        deleteConfirmTitle.textContent = "Hapus Sekolah";
                        deleteConfirmMessage.textContent = `Apakah Anda yakin ingin menghapus sekolah: ${school.sekolah} (${school.npsn})?`;
                        activeDeleteFunction = async () => {
                            await deleteDoc(doc(db, "sekolah", docId));
                        };
                        deleteConfirmModal.classList.add('active');
                    }
                }
            });

            // 4. Event delegation untuk tombol DELETE di tabel LOKUS
            document.getElementById('lokus-tbody').addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.btn-delete-lokus');
                if (deleteBtn) {
                    const kota = deleteBtn.dataset.kota;
                    const schoolsInLokus = allSekolahList.filter(s => s.kota === kota);
                    const userInLokus = allUsersList.find(u => u.kota === kota);
                    deleteConfirmTitle.textContent = "Hapus Lokus";
                    deleteConfirmMessage.innerHTML = `PERINGATAN: Yakin hapus LOKUS "<strong>${kota}</strong>"?<br>Ini akan menghapus <strong>${schoolsInLokus.length} sekolah</strong> dan <strong>${userInLokus ? 1 : 0} user</strong> terkait.`;
                    activeDeleteFunction = async () => {
                        const batch = writeBatch(db);
                        schoolsInLokus.forEach(school => {
                            batch.delete(doc(db, "sekolah", school.id));
                        });
                        if (userInLokus) {
                            batch.delete(doc(db, "users", userInLokus.id));
                        }
                        await batch.commit();
                    };
                    deleteConfirmModal.classList.add('active');
                }
            });

            // 5. Event listener untuk MANAJEMEN USER
            document.getElementById('btn-show-add-user').addEventListener('click', () => {
                userForm.reset();
                hiddenUserId.value = ''; // Pastikan ID kosong untuk mode "Tambah"
                userModalTitle.textContent = "Tambah User Baru";
                userModal.classList.add('active');
            });

            document.getElementById('user-tbody').addEventListener('click', (e) => {
                const editBtn = e.target.closest('.btn-edit-user');
                const deleteBtn = e.target.closest('.btn-delete-user');
                
                if (editBtn) {
                    const docId = editBtn.dataset.id;
                    const user = allUsersList.find(u => u.id === docId);
                    if (user) {
                        hiddenUserId.value = user.id;
                        document.getElementById('user-username').value = user.username || '';
                        document.getElementById('user-password').value = user.password || '';
                        document.getElementById('user-kota').value = user.kota || '';
                        document.getElementById('user-role').value = user.role || 'petugas';
                        userModalTitle.textContent = "Edit User";
                        userModal.classList.add('active');
                    }
                }

                if (deleteBtn) {
                    const docId = deleteBtn.dataset.id;
                    const user = allUsersList.find(u => u.id === docId);
                    if (user) {
                        deleteConfirmTitle.textContent = "Hapus User";
                        deleteConfirmMessage.textContent = `Apakah Anda yakin ingin menghapus user: ${user.username}?`;
                        activeDeleteFunction = async () => {
                            await deleteDoc(doc(db, "users", docId));
                        };
                        deleteConfirmModal.classList.add('active');
                    }
                }
            });

            // 6. Event listener untuk form SIMPAN USER (Tambah/Edit)
            userForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                btnSaveUser.disabled = true;
                btnSaveUser.textContent = "Menyimpan...";

                const docId = hiddenUserId.value;
                const data = {
                    username: document.getElementById('user-username').value,
                    password: document.getElementById('user-password').value,
                    kota: document.getElementById('user-kota').value,
                    role: document.getElementById('user-role').value,
                };

                try {
                    if (docId) {
                        // Mode Edit
                        await updateDoc(doc(db, "users", docId), data);
                    } else {
                        // Mode Tambah
                        // Cek dulu apakah username sudah ada
                        const q = query(collection(db, "users"), where("username", "==", data.username));
                        const snapshot = await getDocs(q);
                        if (!snapshot.empty) {
                            throw new Error(`Username '${data.username}' sudah digunakan.`);
                        }
                        await addDoc(collection(db, "users"), data);
                    }
                    userModal.classList.remove('active');
                } catch (error) {
                    console.error("Error saving user:", error);
                    alert("Gagal menyimpan: " + error.message); // Gunakan alert di sini karena ini error modal
                } finally {
                    btnSaveUser.disabled = false;
                    btnSaveUser.textContent = "Simpan";
                }
            });

            // 7. Event listener untuk tombol LOGOUT
            document.getElementById('logout-button').addEventListener('click', (e) => {
                e.preventDefault();
                // Hapus data login palsu dan segarkan halaman
                appContainer.style.display = 'none';
                modalLogin.classList.add('active');
                usernameInput.value = '';
                passwordInput.value = '';
                loginError.style.display = 'none';
            });
            
            // 8. BARU: Event listener untuk tombol DATABASE
            document.getElementById('btn-reset-data').addEventListener('click', showResetDataConfirm);
            document.getElementById('btn-restore-default').addEventListener('click', showRestoreDefaultConfirm);
            
            // BARU: Panggil pemuat progres saat inisialisasi
            // Pemuatan progres dipanggil di dalam handleDataUpdate() jadi tidak perlu dipanggil di sini lagi
            // loadProgressData(); 
        }

        // --- LOGIKA UTAMA SCRIPT (Fokus pada Login) ---
        
        document.addEventListener('DOMContentLoaded', function() {
            
            if (!db) {
                console.error("Koneksi Firestore gagal.");
                loginError.textContent = "Koneksi ke database gagal. Cek konsol.";
                loginError.style.display = 'block';
                return;
            }

            // Listener untuk form login
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginButton.disabled = true;
                loginButton.textContent = "Mencoba Login...";
                loginError.style.display = 'none';

                const username = usernameInput.value;
                const password = passwordInput.value;

                try {
                    // 1. Cari user berdasarkan username
                    const usersCol = collection(db, "users");
                    const q = query(usersCol, where("username", "==", username));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        throw new Error("Username atau password salah.");
                    }

                    let userFound = false;
                    let isAdmin = false;

                    querySnapshot.forEach(doc => {
                        const user = doc.data();
                        
                        // 2. Cek password
                        if (user.password === password) {
                            userFound = true;
                            // 3. Cek role
                            if (user.role === 'admin') {
                                isAdmin = true;
                            }
                        }
                    });

                    if (!userFound) {
                        throw new Error("Username atau password salah.");
                    }

                    if (!isAdmin) {
                        throw new Error("Login berhasil, namun Anda bukan 'admin'.");
                    }

                    // 4. Jika lolos semua:
                    modalLogin.classList.remove('active');
                    appContainer.style.display = 'flex'; // Tampilkan konten admin
                    initializeAdminPanel(); // Panggil inisialisasi panel admin

                } catch (error) {
                    console.error("Login gagal:", error);
                    loginError.textContent = error.message;
                    loginError.style.display = 'block';
                    loginButton.disabled = false;
                    loginButton.textContent = "Login";
                }
            });

        });
    </script>

</body>
</html>

