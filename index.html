<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Judul Web Baru -->
    <title>Pendampingan Penguatan Literasi dan Numerasi Sekolah Dasar</title>
    
    <!-- Memuat Tailwind CSS dari CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/x-icon" href="https://kemendikdasmen.go.id/web/image/website/21/favicon?unique=c3563e4">      
    
    <!-- Memuat font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- PERUBAHAN: Menambahkan library QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- BARU: Menambahkan Font Awesome untuk ikon ceklis -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Konfigurasi kustom Tailwind untuk font Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    
    <!-- Sedikit CSS tambahan untuk body -->
    <style>
        body {
            /* Membuat font rendering lebih halus */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Style untuk scrollbar di tabel agar lebih menarik */
        .table-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .table-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* Style tambahan untuk QR Code di modal */
        #qrcode > img {
            margin: auto; /* Memastikan gambar QR code ter-center */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans min-h-screen">

    <!-- Kontainer Utama -->
    <div class="container mx-auto max-w-6xl py-12 px-4 sm:px-6 lg:py-20 lg:px-8">

        <!-- Header / Judul Baru -->
        <header class="text-center mb-12 lg:mb-16">
            <h1 class="text-3xl font-bold tracking-tight text-slate-800 sm:text-4xl md:text-5xl">
                Pendampingan Penguatan <br class="block md:hidden">
                Literasi dan Numerasi Sekolah Dasar
            </h1>
            <p class="mt-4 text-lg text-slate-600 max-w-2xl mx-auto">
                Silakan pilih salah satu menu di bawah ini untuk melihat materi pendampingan atau data sekolah lokus.
            </p>
        </header>

        <!-- Grid untuk Card -->
        <main class="grid grid-cols-1 gap-8 sm:grid-cols-2 lg:grid-cols-3">

            <!-- Card 1: Materi Pendampingan (Membuka Modal Slide) -->
            <a href="javascript:void(0)" id="openSlideModalBtn" class="group block rounded-xl bg-white shadow-lg overflow-hidden transition-all duration-300 ease-in-out hover:shadow-2xl hover:-translate-y-2">
                <div class="p-6">
                    <!-- Ikon -->
                    <div class="flex items-center justify-center w-12 h-12 rounded-full bg-yellow-100 text-yellow-600 mb-4 transition-all duration-300 group-hover:bg-yellow-600 group-hover:text-white">
                        <!-- Ikon (Presentation) -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125v-1.5c0-.621.504-1.125 1.125-1.125H5.25l1.125-1.125h12.75l1.125 1.125h2.625c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h17.25m-17.25 0h17.25M9 9.563c0-1.036.84-1.875 1.875-1.875h2.25c1.035 0 1.875.84 1.875 1.875v5.25c0 1.035-.84 1.875-1.875 1.875h-2.25A1.875 1.875 0 0 1 9 14.812v-5.25ZM14.25 9a.75.75 0 0 0-1.5 0v5.25a.75.75 0 0 0 1.5 0v-5.25Z" />
                        </svg>
                    </div>
                    <!-- Konten Teks -->
                    <h3 class="text-xl font-semibold text-slate-800 mb-2 transition-colors duration-300 group-hover:text-yellow-600">
                        Materi Pendampingan
                    </h3>
                    <p class="text-slate-500 text-base">
                        Lihat slide presentasi materi penguatan literasi dan numerasi.
                    </p>
                </div>
            </a>

            <!-- Card 2: Data Sekolah (Membuka Modal) -->
            <a href="javascript:void(0)" id="openDataModalBtn" class="group block rounded-xl bg-white shadow-lg overflow-hidden transition-all duration-300 ease-in-out hover:shadow-2xl hover:-translate-y-2">
                <div class="p-6">
                    <!-- Ikon -->
                    <div class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-100 text-blue-600 mb-4 transition-all duration-300 group-hover:bg-blue-600 group-hover:text-white">
                        <!-- Ikon (Database/Building) -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75Z" />
                        </svg>
                    </div>
                    <!-- Konten Teks -->
                    <h3 class="text-xl font-semibold text-slate-800 mb-2 transition-colors duration-300 group-hover:text-blue-600">
                        Data Sekolah Lokus
                    </h3>
                    <p class="text-slate-500 text-base">
                        Jelajahi data sekolah yang menjadi lokus pendampingan di berbagai wilayah.
                    </p>
                </div>
            </a>
            
            <!-- ============================================= -->
            <!-- BARU: Card 3: Progres Input (Membuka Modal)   -->
            <!-- ============================================= -->
            <a href="javascript:void(0)" id="openProgresModalBtn" class="group block rounded-xl bg-white shadow-lg overflow-hidden transition-all duration-300 ease-in-out hover:shadow-2xl hover:-translate-y-2">
                <div class="p-6">
                    <!-- Ikon -->
                    <div class="flex items-center justify-center w-12 h-12 rounded-full bg-purple-100 text-purple-600 mb-4 transition-all duration-300 group-hover:bg-purple-600 group-hover:text-white">
                        <!-- Ikon (Checklist / Chart) -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.125 2.25h-4.5c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125v-9M10.125 2.25h.375a9 9 0 0 1 9 9v.375M10.125 2.25A3.375 3.375 0 0 1 13.5 5.625v1.5c0 .621.504 1.125 1.125 1.125h1.5a3.375 3.375 0 0 1 3.375 3.375M9 15l2.25 2.25L15 12" />
                        </svg>
                    </div>
                    <!-- Konten Teks -->
                    <h3 class="text-xl font-semibold text-slate-800 mb-2 transition-colors duration-300 group-hover:text-purple-600">
                        Progres Input
                    </h3>
                    <p class="text-slate-500 text-base">
                        Lihat persentase pengisian data formulir (FGD, Laporan, dll).
                    </p>
                </div>
            </a>

            <!-- Card 4: Modal Surat (Membuka Modal) -->
            <a href="javascript:void(0)" id="openSuratModalBtn" class="group block rounded-xl bg-white shadow-lg overflow-hidden transition-all duration-300 ease-in-out hover:shadow-2xl hover:-translate-y-2">
                <div class="p-6">
                    <!-- Ikon -->
                    <div class="flex items-center justify-center w-12 h-12 rounded-full bg-green-100 text-green-600 mb-4 transition-all duration-300 group-hover:bg-green-600 group-hover:text-white">
                        <!-- Ikon (Mail) -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
                        </svg>
                    </div>
                    <!-- Konten Teks -->
                    <h3 class="text-xl font-semibold text-slate-800 mb-2 transition-colors duration-300 group-hover:text-green-600">
                        Surat
                    </h3>
                    <p class="text-slate-500 text-base">
                        Akses berbagai templat surat dan dokumen perjalanan dinas.
                    </p>
                </div>
            </a>

        </main> <!-- PENUTUP GRID <main> PERTAMA -->

            <section class="mt-16 lg:mt-20">

            <!-- Layout Flexbox untuk 3 Card Lingkaran Baru -->
            <div class="flex flex-col sm:flex-row flex-wrap items-center justify-center gap-8 lg:gap-12">
            
                <a href="Admin.html" class="group relative flex flex-col items-center justify-center w-56 h-56 rounded-full bg-white shadow-lg transition-all duration-300 ease-in-out hover:shadow-2xl hover:-translate-y-2">
                    <!-- Ikon Bulat -->
                    <div class="flex items-center justify-center w-20 h-20 rounded-full bg-purple-100 text-purple-600 mb-2 transition-all duration-300 group-hover:bg-purple-600 group-hover:text-white group-hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.602-3.751m-.228-1.120a14.247 14.247 0 0 0-1.226-1.045M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                        </svg>
                    </div>
                    <!-- Konten Teks -->
                    <h3 class="text-2xl font-semibold text-slate-800 transition-colors duration-300 group-hover:text-purple-600">
                        Admin
                    </h3>
                </a>

                <!-- Link Petugas diubah untuk membuka modal password -->
                <a href="javascript:void(0)" id="openPetugasPasswordBtn" class="group relative flex flex-col items-center justify-center w-56 h-56 rounded-full bg-white shadow-lg transition-all duration-300 ease-in-out hover:shadow-2xl hover:-translate-y-2">
                    <!-- Ikon Bulat -->
                    <div class="flex items-center justify-center w-20 h-20 rounded-full bg-teal-100 text-teal-600 mb-2 transition-all duration-300 group-hover:bg-teal-600 group-hover:text-white group-hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.125 2.25h-4.5c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125v-9M10.125 2.25h.375a9 9 0 0 1 9 9v.375M10.125 2.25A3.375 3.375 0 0 1 13.5 5.625v1.5c0 .621.504 1.125 1.125 1.125h1.5a3.375 3.375 0 0 1 3.375 3.375M9 15l2.25 2.25L15 12" />
                        </svg>
                    </div>
                    <!-- Konten Teks -->
                    <h3 class="text-2xl font-semibold text-slate-800 transition-colors duration-300 group-hover:text-teal-600">
                        Petugas
                    </h3>
                </a>

                <!-- PERUBAHAN: Link Sekolah diubah untuk membuka modal link -->
                <a href="javascript:void(0)" id="openSekolahModalBtn" class="group relative flex flex-col items-center justify-center w-56 h-56 rounded-full bg-white shadow-lg transition-all duration-300 ease-in-out hover:shadow-2xl hover:-translate-y-2">
                    <!-- Ikon Bulat -->
                    <div class="flex items-center justify-center w-20 h-20 rounded-full bg-blue-100 text-blue-600 mb-2 transition-all duration-300 group-hover:bg-blue-600 group-hover:text-white group-hover:scale-110">
                        <!-- Ikon Gedung Sekolah (disesuaikan w-10 h-10) -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75Z" />
                        </svg>
                    </div>
                    <!-- Konten Teks -->
                    <h3 class="text-2xl font-semibold text-slate-800 transition-colors duration-300 group-hover:text-blue-600">
                        Sekolah
                    </h3>
                </a>
                <!-- ===== AKHIR CARD BARU ===== -->

                <!-- Card 6: Travel (Bentuk Lingkaran, Membuka Modal) -->
                <a href="javascript:void(0)" id="openTravelModalBtn" class="group relative flex flex-col items-center justify-center w-56 h-56 rounded-full bg-white shadow-lg transition-all duration-300 ease-in-out hover:shadow-2xl hover:-translate-y-2">
                    <!-- Ikon Bulat -->
                    <div class="flex items-center justify-center w-20 h-20 rounded-full bg-cyan-100 text-cyan-600 mb-2 transition-all duration-300 group-hover:bg-cyan-600 group-hover:text-white group-hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L6 12Zm0 0h7.5" />
                        </svg>
                    </div>
                    <!-- Konten Teks -->
                    <h3 class="text-2xl font-semibold text-slate-800 transition-colors duration-300 group-hover:text-cyan-600">
                        Travel
                    </h3>
                </a>

            </div> <!-- PENUTUP FLEXBOX "AKSES CEPAT" -->
        </section> <!-- PENUTUP SECTION "AKSES CEPAT" -->

    </div>

    <!-- Footer -->
    <footer class="text-center py-10 mt-12 border-t border-slate-200">
        <p class="text-slate-500">&copy; 2025 Pendampingan Literasi & Numerasi. Dibuat dengan Tailwind CSS.</p>
    </footer>

    <!-- ===== MODAL UNTUK PREVIEW SLIDE (DIUBAH) ===== -->
    <div id="slideModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm hidden">
        <!-- Kotak Modal (Diubah strukturnya) -->
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-6xl mx-auto overflow-hidden flex flex-col" style="max-height: 90vh;">
            <!-- Header Modal (Diubah) -->
            <div class="flex items-center justify-between p-4 border-b shrink-0">
                <h3 id="slideModalTitle" class="text-lg font-semibold">Materi Pendampingan</h3>
                <button id="closeSlideModalBtn" class="text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Body Modal: Wrapper untuk dua view (BARU) -->
            <div class="flex-grow overflow-auto">
                
                <!-- View 1: Daftar Materi (BARU) -->
                <div id="materiList" class="p-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        
                        <!-- Card 1.1: Desain Program -->
                        <a href="javascript:void(0)" class="materi-preview-btn block p-6 rounded-lg bg-yellow-50 hover:bg-yellow-100 transition-colors border border-yellow-200"
                           data-title="Desain Program"
                           data-src="https://docs.google.com/presentation/d/e/2PACX-1vRHLrM1loLAxqOm57FU9q2W7CSSa8Ih-nKFAdaBqsrJ5kZ4g38q-BayMAB28oqzs26FIxdGgec_O1ad/pubembed?start=true&loop=true&delayms=5000">
                            <h4 class="font-semibold text-yellow-800">Desain Program</h4>
                            <p class="text-sm text-yellow-700">Lihat slide presentasi utama.</p>
                        </a>
                        
                        <!-- Card 1.2: Paparan Sesi Orientasi -->
                        <a href="https://drive.google.com/drive/folders/1FFudQw01PoAH253BwZSHzmRsJABJBkHx" target="_blank" class="materi-link-btn block p-6 rounded-lg bg-blue-50 hover:bg-blue-100 transition-colors border border-blue-200">
                            <h4 class="font-semibold text-blue-800">Paparan Sesi Orientasi</h4>
                            <p class="text-sm text-blue-700">Materi dari sesi orientasi.</p>
                        </a>

                        <!-- Card 1.3: Format Rencana Program -->
                        <a href="https://docs.google.com/document/d/1zvbGw69WzrjFz0rOvI2hK6aARCDDjE0JaCBGd0RNE-c/edit?usp=drive_link" target="_blank" class="materi-link-btn block p-6 rounded-lg bg-teal-50 hover:bg-teal-100 transition-colors border border-teal-200">
                            <h4 class="font-semibold text-teal-800">Format Rencana Program</h4>
                            <p class="text-sm text-teal-700">Unduh template format.</p>
                        </a>

                        <!-- Card 1.4: Unggah Draf Rencana -->
                        <a href="javascript:void(0)" class="open-soon-modal-btn block p-6 rounded-lg bg-purple-50 hover:bg-purple-100 transition-colors border border-purple-200">
                            <h4 class="font-semibold text-purple-800">Unggah Draf Rencana</h4>
                            <p class="text-sm text-purple-700">Upload draf Anda di sini.</p>
                        </a>
                        
                        <!-- Card 1.5: Unggah Rencana Final -->
                        <a href="javascript:void(0)" class="open-soon-modal-btn block p-6 rounded-lg bg-green-50 hover:bg-green-100 transition-colors border border-green-200">
                            <h4 class="font-semibold text-green-800">Unggah Rencana Final</h4>
                            <p class="text-sm text-green-700">Upload versi final Anda.</p>
                        </a>

                        <!-- Card 1.6: Unggah Log Implementasi -->
                        <a href="javascript:void(0)" class="open-soon-modal-btn block p-6 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors border border-gray-200">
                            <h4 class="font-semibold text-gray-800">Unggah Log Implementasi</h4>
                            <p class="text-sm text-gray-700">Catatan implementasi.</p>
                        </a>
                    </div>
                </div>

                <!-- View 2: Preview Iframe (Dipindahkan) -->
                <div id="materiPreview" class="hidden h-full flex flex-col">
                    <!-- Konten Iframe -->
                    <div class="p-4 bg-slate-100 flex-grow overflow-auto">
                        <div class="aspect-video w-full">
                            <iframe id="materiIframe" 
                                src="about:blank" 
                                frameborder="0" 
                                width="100%" 
                                height="100%" 
                                allowfullscreen="true" 
                                mozallowfullscreen="true" 
                                webkitallowfullscreen="true">
                            </iframe>
                        </div>
                    </div>
                    <!-- Footer (Tombol Kembali) -->
                    <div class="p-4 border-t shrink-0 bg-slate-50 flex justify-between items-center">
                        <button id="materiBackBtn" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-semibold transition-colors duration-200 hover:bg-slate-300">
                            &larr; Kembali
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ===== MODAL UNTUK DATA SEKOLAH (DIKEMBALIKAN KE VERSI ASLI) ===== -->
    <div id="dataModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm hidden">
        <!-- Kotak Modal -->
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-6xl mx-auto overflow-hidden flex flex-col" style="max-height: 90vh;">
            <!-- Header Modal -->
            <div class="flex items-center justify-between p-4 border-b shrink-0">
                <h3 class="text-lg font-semibold">Data Sekolah Lokus</h3>
                <button id="closeDataModalBtn" class="text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Filter Dropdown -->
            <div class="p-4 border-b shrink-0">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Dropdown Provinsi -->
                    <div>
                        <label for="provinsiFilter" class="block text-sm font-medium text-slate-700 mb-1">Provinsi</label>
                        <select id="provinsiFilter" class="w-full p-2 border rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="semua">Semua Provinsi</option>
                        </select>
                    </div>
                    <!-- Dropdown Nama Sekolah -->
                    <div>
                        <label for="sekolahFilter" class="block text-sm font-medium text-slate-700 mb-1">Nama Sekolah</label>
                        <select id="sekolahFilter" class="w-full p-2 border rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                             <option value="semua">Semua Sekolah</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Body Modal (Konten Tabel) -->
            <div class="p-4 overflow-auto table-scrollbar">
                <div class="overflow-x-auto rounded-lg border">
                    <table id="sekolahTable" class="w-full min-w-[900px] text-left text-sm">
                        <thead class="bg-slate-100 text-slate-600 uppercase tracking-wider sticky top-0">
                            <tr>
                                <!-- ================================== -->
                                <!-- REVERT: Kolom Progres DIHAPUS      -->
                                <!-- ================================== -->
                                <th class="p-4">NPSN</th>
                                <th class="p-4">Nama Sekolah</th>
                                <th class="p-4">Provinsi</th>
                                <th class="p-4">Kab/Kota</th>
                                <th class="p-4">Petugas 1</th>
                                <th class="p-4">Petugas 2</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y">
                            <!-- REVERT: Colspan kembali ke 6 -->
                            <tr>
                                <td colspan="6" class="text-center p-6 text-slate-500">
                                    Memuat data dari database...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- MODAL PROGRES (VERSI PERMINTAAN ANDA)         -->
    <!-- ============================================= -->
    <div id="progresModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm hidden">
        <!-- Kotak Modal (DIPERBESAR) -->
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-7xl mx-auto overflow-hidden flex flex-col" style="max-height: 95vh;">
            
            <!-- Header Modal -->
            <div class="flex items-center justify-between p-4 border-b shrink-0">
                <h3 class="text-lg font-semibold">Progres Input Data</h3>
                <button id="closeProgresModalBtn" class="text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Kontrol Tampilan (Toggle Button) -->
            <div class="p-4 bg-slate-50 border-b shrink-0 flex flex-col sm:flex-row justify-between items-center gap-4">
                <!-- Tombol Toggle -->
                <div class="flex-shrink-0">
                    <button id="detailedReportBtn" class="px-4 py-2 rounded-l-lg font-semibold bg-blue-600 text-white transition-colors">
                        Laporan Rinci (per NPSN)
                    </button>
                    <button id="summaryReportBtn" class="px-4 py-2 rounded-r-lg font-semibold bg-white text-slate-700 border border-slate-300 transition-colors hover:bg-slate-100">
                        Rekap Progres (per Judul)
                    </button>
                </div>
                
                <!-- Filter untuk Tampilan Rinci -->
                <div id="progresFilterContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full sm:w-auto">
                    <div>
                        <label for="progresProvinsiFilter" class="block text-xs font-medium text-slate-600">Provinsi</label>
                        <select id="progresProvinsiFilter" class="w-full p-2 border rounded-lg bg-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="semua">Semua Provinsi</option>
                        </select>
                    </div>
                    <div>
                        <label for="progresSekolahFilter" class="block text-xs font-medium text-slate-600">Sekolah</label>
                        <select id="progresSekolahFilter" class="w-full p-2 border rounded-lg bg-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                             <option value="semua">Semua Sekolah</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Body Modal (Konten Progres) -->
            <div class="flex-grow overflow-auto">
                <!-- Tampilan 1: Laporan Rinci (Tabel per NPSN) -->
                <div id="detailedReportView" class="p-4 table-scrollbar">
                    <div class="overflow-x-auto rounded-lg border">
                        <table class="w-full min-w-[1200px] text-left text-sm">
                            <thead class="bg-slate-100 text-slate-600 uppercase tracking-wider sticky top-0">
                                <tr>
                                    <th class="p-3">No</th>
                                    <th class="p-3">Provinsi</th>
                                    <th class="p-3">Kab/Kota</th>
                                    <th class="p-3">NPSN</th>
                                    <th class="p-3">Nama Sekolah</th>
                                    <th class="p-3 text-center">Progres</th>
                                    <th class="p-3 text-center">Observasi</th>
                                    <th class="p-3 text-center">FGD</th>
                                    <th class="p-3 text-center">W. Guru</th>
                                    <th class="p-3 text-center">W. Murid</th>
                                    <th class="p-3 text-center">Laporan</th>
                                    <th class="p-3 text-center">Program</th>
                                </tr>
                            </thead>
                            <tbody id="progresDetailedTableBody" class="divide-y">
                                <tr>
                                    <td colspan="12" class="text-center p-6 text-slate-500">
                                        <i class="fas fa-spinner fa-spin mr-2"></i> Memuat data progres rinci...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Tampilan 2: Rekap Progres (Seperti yang saya buat sebelumnya) -->
                <div id="summaryReportView" class="hidden p-6 max-w-2xl mx-auto w-full">
                    <div id="progresSummaryContent" class="space-y-5">
                        <p class="text-center text-slate-500">Memuat data rekap...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- ===== MODAL UNTUK SURAT (DIKEMBALIKAN) ===== -->
    <div id="suratModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm hidden">
        <!-- Kotak Modal -->
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl mx-auto overflow-hidden flex flex-col" style="max-height: 90vh;">
            <!-- Header Modal -->
            <div class="flex items-center justify-between p-4 border-b shrink-0">
                <h3 id="suratModalTitle" class="text-lg font-semibold">Pilih Jenis Surat</h3>
                <button id="closeSuratModalBtn" class="text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Body Modal: Wrapper untuk dua view -->
            <div class="flex-grow overflow-auto">
                
                <!-- View 1: Daftar Surat (Tombol) -->
                <div id="suratList" class="p-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <a href="javascript:void(0)" data-title="Surat Tugas" data-pdf-src="https://drive.google.com/file/d/1mP3d0u3ChumUJxIxjroW3awmUuN_jH8v/preview" data-download-src="https://drive.google.com/uc?export=download&id=1mP3d0u3ChumUJxIxjroW3awmUuN_jH8v" class="pdf-button block text-center w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold transition-colors duration-200 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Surat Tugas
                        </a>
                        <a href="javascript:void(0)" data-title="Surat Dinas" data-pdf-src="https://drive.google.com/file/d/1viU4z92VVkL5rwbbqHPlZns3t3G12Dgp/preview" data-download-src="https://drive.google.com/uc?export=download&id=1viU4z92VVkL5rwbbqHPlZns3t3G12Dgp" class="pdf-button block text-center w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold transition-colors duration-200 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Surat Dinas
                        </a>
                        <a href="javascript:void(0)" data-title="Surat UPT" data-pdf-src="https://drive.google.com/file/d/1sPxT2VzfF_Gfal1ixs-dhnXJimxOEdKj/preview" data-download-src="https://drive.google.com/uc?export=download&id=1sPxT2VzfF_Gfal1ixs-dhnXJimxOEdKj" class="pdf-button block text-center w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold transition-colors duration-200 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Surat UPT
                        </a>
                        <a href="javascript:void(0)" data-title="Perjadin" data-pdf-src="https://drive.google.com/file/d/1y5HD_CAjCoMqnEaBP7Bn5YKYgFZ9E8OT/preview" data-download-src="https://drive.google.com/uc?export=download&id=1y5HD_CAjCoMqnEaBP7Bn5YKYgFZ9E8OT" class="pdf-button block text-center w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold transition-colors duration-200 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Perjadin
                        </a>
                    </div>
                </div>

                <!-- View 2: Preview PDF (Tersembunyi by default) -->
                <div id="suratPreview" class="hidden h-full flex flex-col">
                    <!-- Konten Iframe -->
                    <div class="p-4 bg-slate-100 flex-grow overflow-auto">
                        <iframe id="suratIframe" src="about:blank" width="100%" height="100%" style="min-height: 60vh;" frameborder="0"></iframe>
                    </div>
                    <!-- Footer (Tombol Kembali & Download) -->
                    <div class="p-4 border-t shrink-0 bg-slate-50 flex justify-between items-center">
                        <button id="suratBackBtn" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-semibold transition-colors duration-200 hover:bg-slate-300">
                            &larr; Kembali
                        </button>
                        <a id="suratDownloadBtn" href="#" download class="inline-block px-6 py-2 bg-green-600 text-white rounded-lg font-semibold transition-colors duration-200 hover:bg-green-700">
                            Download PDF
                        </a>
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <!-- ===== MODAL UNTUK TRAVEL (DIKEMBALIKAN) ===== -->
    <div id="travelModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm hidden">
        <!-- Kotak Modal -->
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md mx-auto overflow-hidden">
            <!-- Header Modal -->
            <div class="flex items-center justify-between p-4 border-b">
                <h3 class="text-lg font-semibold">Informasi Travel</h3>
                <button id="closeTravelModalBtn" class="text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <!-- Body Modal (Konten) -->
            <div class="p-6">
                <h4 class="text-xl font-semibold text-slate-800 mb-2">PT. Angkasa Raya Muda</h4>
                <p class="text-slate-600 mb-4">Biro Perjalanan Wisata Tour and Travel</p>
                
                <!-- Tombol WhatsApp -->
                <a href="https://wa.me/6281356788023" target="_blank" class="mb-6 w-full flex items-center justify-center gap-2 px-4 py-3 bg-green-500 text-white rounded-lg font-semibold transition-colors duration-200 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M16.75 13.96c.25.13.41.38.41.66v.38c0 .32-.19.61-.48.74c-.5.21-1.11.36-1.7.36c-.88 0-1.71-.21-2.48-.61c-1.31-.68-2.44-1.63-3.3-2.8c-.61-.83-1.02-1.74-1.2-2.71c-.03-.17-.04-.33-.04-.5c0-.78.23-1.5.61-2.1c.2-.31.51-.5.87-.5h.38c.32 0 .61.19.73.48c.18.45.41.89.68 1.3c.13.19.16.44.07.66c-.14.33-.3.65-.48.94c-.17.28-.14.65.08.89c.5.55 1.08 1.04 1.71 1.45c.4.26.85.42 1.32.42c.3 0 .59-.08.84-.23c.27-.16.56-.28.88-.36c.27-.07.56.02.76.21l.2.2zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8z"/></svg>
                    WhatsApp: 6281356788023
                </a>

                <h5 class="font-semibold text-slate-700 mb-2">Melayani :</h5>
                <ul class="list-disc list-inside text-slate-600 space-y-1">
                    <li>Tiket Pesawat</li>
                    <li>Voucher Hotel</li>
                    <li>Pembuatan Visa/Passport</li>
                    <li>Rental Car</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ===== MODAL UNTUK "COMING SOON" (DIKEMBALIKAN) ===== -->
    <div id="soonModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm hidden">
        <!-- Kotak Modal (dibuat mirip travelModal/Admin.html) -->
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md mx-auto overflow-hidden relative">
            <!-- Tombol Close (dipindah ke dalam agar mudah) -->
            <button id="closeSoonModalBtn" class="absolute top-3 right-3 text-slate-400 hover:text-slate-600 z-10">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
            </button>
            <!-- Body Modal (Konten) -->
            <div class="p-8 pt-10 text-center">
                <!-- Gambar Admin (sesuai permintaan) -->
                <img src="awalia.png" alt="Admin Sibuk" class="w-40 h-40 rounded-full object-cover mb-6 mx-auto border-4 border-orange-200 shadow-lg transition-transform duration-300 hover:scale-110">
                
                <h3 class="text-2xl font-bold text-slate-800 mb-3">Mohon Maaf</h3>
                <p class="text-slate-600 text-lg">
                    Halaman akan segera terbit, Admin saat ini sedang sibuk berenang di Danau Batur.
                </p>
            </div>
        </div>
    </div>

    <!-- ===== MODAL UNTUK PASSWORD PETUGAS (BARU) ===== -->
    <div id="petugasPasswordModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm hidden">
        <!-- Kotak Modal -->
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm mx-auto overflow-hidden">
            <!-- Header Modal -->
            <div class="flex items-center justify-between p-4 border-b">
                <h3 class="text-lg font-semibold">Password Petugas</h3>
                <button id="closePetugasPasswordModalBtn" class="text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <!-- Body Modal (Form) -->
            <form id="petugasPasswordForm" class="p-6">
                <label for="petugasPasswordInput" class="block text-sm font-medium text-slate-700 mb-2">Masukkan Password:</label>
                <input type="password" id="petugasPasswordInput" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" autocomplete="current-password">
                <p id="petugasPasswordError" class="text-red-500 text-sm mt-2 hidden">Password salah. Silakan coba lagi.</p>
                <button type="submit" class="mt-6 w-full px-4 py-2 bg-teal-600 text-white rounded-lg font-semibold transition-colors duration-200 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2">
                    Masuk
                </button>
            </form>
        </div>
    </div>

    <!-- ===== MODAL UNTUK LINK SEKOLAH (BARU) ===== -->
    <div id="sekolahModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm hidden">
        <!-- Kotak Modal -->
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md mx-auto overflow-hidden">
            <!-- Header Modal -->
            <div class="flex items-center justify-between p-4 border-b">
                <h3 class="text-lg font-semibold">Bagikan Tautan Sekolah</h3>
                <button id="closeSekolahModalBtn" class="text-slate-400 hover:text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <!-- Body Modal (Konten) -->
            <div class="p-6 space-y-4 text-center">
                <p class="text-slate-600">Bagikan tautan ini kepada sekolah untuk akses langsung.</p>
                
                <!-- QR Code -->
                <div id="qrcode" class="flex justify-center items-center p-4 bg-white border rounded-lg w-56 h-56 mx-auto overflow-hidden">
                    <!-- QR Code akan digenerate di sini oleh JS -->
                </div>
                
                <!-- Link Input -->
                <div class="flex">
                    <input type="text" id="sekolahLink" value="Memuat..." readonly class="w-full p-2 border rounded-l-lg bg-slate-100 text-slate-700 text-sm truncate">
                    <button id="copyLinkBtn" title="Salin Tautan" class="flex-shrink-0 px-4 py-2 bg-blue-600 text-white rounded-r-lg font-semibold transition-colors duration-200 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        <!-- Ikon Salin/Copy -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5-.124m7.5 10.375h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.436-3.41-8.16-7.8-8.6C7.688 2.088 4.5 4.799 4.5 8.25v10.5A2.25 2.25 0 0 0 6.75 21h6.75c.621 0 1.125-.504 1.125-1.125V17.25Z" />
                        </svg>
                    </button>
                </div>
                <p id="copyMessage" class="text-green-500 text-sm !-mt-0 h-4 hidden">Tautan disalin!</p>
                
                <!-- Tombol Aksi -->
                <a href="Sekolah.html" class="block w-full px-4 py-3 bg-teal-600 text-white rounded-lg font-semibold text-center transition-colors duration-200 hover:bg-teal-700">
                    Lanjut ke Halaman Sekolah
                </a>
            </div>
        </div>
    </div>


    <!-- ===== JAVASCRIPT ===== -->
    
    <!-- PERUBAHAN 4: Menambahkan skrip Firebase -->
    <script type="module">
        // Impor modul Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyAi_-eBHTWJVa-xHkKgrCKZkAgzlzNCccA",
          authDomain: "direktorat-sd.firebaseapp.com",
          projectId: "direktorat-sd",
          storageBucket: "direktorat-sd.firebasestorage.app",
          messagingSenderId: "215819821063",
          appId: "1:215819821063:web:4bdb7f127acbc1cfde4aa2"
        };

        // Inisialisasi Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            setLogLevel('debug');
            console.log("Firebase berhasil diinisialisasi untuk index.html.");
        } catch (e) {
            console.error("Error inisialisasi Firebase:", e);
            document.getElementById('tableBody').innerHTML = `<tr><td colspan="6" class="text-center p-6 text-red-500">Gagal terhubung ke database.</td></tr>`;
        }

        // ==================================================
        // BARU: Variabel Global untuk Progres
        // ==================================================
        let allSekolahList = [];
        // Map(NPSN -> count) untuk menyimpan data submission
        let fgdSubmissions = new Map();
        let guruSubmissions = new Map();
        let observasiSubmissions = new Map();
        let muridSubmissions = new Map();
        let laporanSubmissions = new Map();
        // BARU: Menambahkan 'program'
        let programSubmissions = new Map(); 
        const formTypes = ['fgd', 'wawancara_guru', 'observasi', 'wawancara_murid', 'laporan', 'program'];
        // BARU: Total form
        const TOTAL_FORMS = 6;
        // ==================================================


        document.addEventListener('DOMContentLoaded', () => {

            // --- Elemen Modal Slide ---
            const openSlideModalBtn = document.getElementById('openSlideModalBtn');
            const closeSlideModalBtn = document.getElementById('closeSlideModalBtn');
            const slideModal = document.getElementById('slideModal');
            const slideModalTitle = document.getElementById('slideModalTitle');
            const materiList = document.getElementById('materiList');
            const materiPreview = document.getElementById('materiPreview');
            const materiPreviewButtons = document.querySelectorAll('.materi-preview-btn');
            const materiBackBtn = document.getElementById('materiBackBtn');
            const materiIframe = document.getElementById('materiIframe');

            // --- Elemen Modal Data ---
            const openDataModalBtn = document.getElementById('openDataModalBtn');
            const closeDataModalBtn = document.getElementById('closeDataModalBtn');
            const dataModal = document.getElementById('dataModal');
            
            // =============================================
            // BARU: Elemen Modal Progres
            // =============================================
            const openProgresModalBtn = document.getElementById('openProgresModalBtn');
            const closeProgresModalBtn = document.getElementById('closeProgresModalBtn');
            const progresModal = document.getElementById('progresModal');
            // Kontrol Tampilan
            const detailedReportBtn = document.getElementById('detailedReportBtn');
            const summaryReportBtn = document.getElementById('summaryReportBtn');
            const detailedReportView = document.getElementById('detailedReportView');
            const summaryReportView = document.getElementById('summaryReportView');
            const progresFilterContainer = document.getElementById('progresFilterContainer');
            // Filter
            const progresProvinsiFilter = document.getElementById('progresProvinsiFilter');
            const progresSekolahFilter = document.getElementById('progresSekolahFilter');
            // Konten
            const progresDetailedTableBody = document.getElementById('progresDetailedTableBody');
            const progresSummaryContent = document.getElementById('progresSummaryContent');
            // =============================================

            // --- Elemen Modal Surat ---
            const openSuratModalBtn = document.getElementById('openSuratModalBtn');
            const closeSuratModalBtn = document.getElementById('closeSuratModalBtn');
            const suratModal = document.getElementById('suratModal');
            const suratModalTitle = document.getElementById('suratModalTitle');
            const suratList = document.getElementById('suratList');
            const suratPreview = document.getElementById('suratPreview');
            const suratModalButtons = document.querySelectorAll('#suratList .pdf-button');
            const suratBackBtn = document.getElementById('suratBackBtn');
            const suratIframe = document.getElementById('suratIframe');
            const suratDownloadBtn = document.getElementById('suratDownloadBtn');

            // --- Elemen Modal Travel ---
            const openTravelModalBtn = document.getElementById('openTravelModalBtn');
            const closeTravelModalBtn = document.getElementById('closeTravelModalBtn');
            const travelModal = document.getElementById('travelModal');

            // --- Elemen Modal "Soon" ---
            const soonModal = document.getElementById('soonModal');
            const closeSoonModalBtn = document.getElementById('closeSoonModalBtn');
            const openSoonModalBtns = document.querySelectorAll('.open-soon-modal-btn');

            // --- Elemen Modal Password Petugas ---
            const openPetugasPasswordBtn = document.getElementById('openPetugasPasswordBtn');
            const petugasPasswordModal = document.getElementById('petugasPasswordModal');
            const closePetugasPasswordModalBtn = document.getElementById('closePetugasPasswordModalBtn');
            const petugasPasswordForm = document.getElementById('petugasPasswordForm');
            const petugasPasswordInput = document.getElementById('petugasPasswordInput');
            const petugasPasswordError = document.getElementById('petugasPasswordError');

            // --- Elemen Modal Link Sekolah (BARU) ---
            const openSekolahModalBtn = document.getElementById('openSekolahModalBtn');
            const sekolahModal = document.getElementById('sekolahModal');
            const closeSekolahModalBtn = document.getElementById('closeSekolahModalBtn');
            const qrcodeDiv = document.getElementById('qrcode');
            const copyLinkBtn = document.getElementById('copyLinkBtn');
            const sekolahLinkInput = document.getElementById('sekolahLink');
            const copyMessage = document.getElementById('copyMessage');

            // --- Elemen Filter dan Tabel ---
            const provinsiFilter = document.getElementById('provinsiFilter');
            const sekolahFilter = document.getElementById('sekolahFilter');
            const tableBody = document.getElementById('tableBody');

            // --- FUNGSI MODAL ---
            const openModal = (modal) => modal.classList.remove('hidden');
            const closeModal = (modal) => modal.classList.add('hidden');

            // --- FUNGSI UNTUK MODAL MATERI ---
            function showMateriList() {
                materiPreview.classList.add('hidden');
                materiList.classList.remove('hidden');
                slideModalTitle.textContent = 'Materi Pendampingan';
                materiIframe.src = 'about:blank'; 
            }

            openSlideModalBtn.addEventListener('click', () => openModal(slideModal));
            closeSlideModalBtn.addEventListener('click', () => {
                closeModal(slideModal);
                setTimeout(showMateriList, 300); 
            });
            slideModal.addEventListener('click', (e) => {
                if (e.target === slideModal) {
                    closeModal(slideModal);
                    setTimeout(showMateriList, 300); 
                }
            });

            materiPreviewButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const title = button.getAttribute('data-title');
                    const iframeSrc = button.getAttribute('data-src');
                    slideModalTitle.textContent = `Preview: ${title}`;
                    materiIframe.src = iframeSrc;
                    materiList.classList.add('hidden');
                    materiPreview.classList.remove('hidden');
                });
            });

            materiBackBtn.addEventListener('click', showMateriList);

            // Event Listener Modal Data
            openDataModalBtn.addEventListener('click', () => {
                openModal(dataModal);
            });
            closeDataModalBtn.addEventListener('click', () => closeModal(dataModal));
            dataModal.addEventListener('click', (e) => {
                if (e.target === dataModal) closeModal(dataModal);
            });
            
            // =============================================
            // BARU: Event Listener Modal Progres
            // =============================================
            openProgresModalBtn.addEventListener('click', () => {
                // Saat dibuka, selalu reset ke tampilan rinci
                showDetailedReport();
                // Perbarui kedua tampilan
                updateProgresSummary(); 
                applyProgresFilters();
                openModal(progresModal);
            });
            closeProgresModalBtn.addEventListener('click', () => closeModal(progresModal));
            progresModal.addEventListener('click', (e) => {
                if (e.target === progresModal) closeModal(progresModal);
            });

            // Fungsi untuk beralih tampilan di modal progres
            function showDetailedReport() {
                detailedReportView.classList.remove('hidden');
                progresFilterContainer.classList.remove('hidden');
                summaryReportView.classList.add('hidden');
                
                detailedReportBtn.classList.add('bg-blue-600', 'text-white');
                detailedReportBtn.classList.remove('bg-white', 'text-slate-700', 'border');
                
                summaryReportBtn.classList.add('bg-white', 'text-slate-700', 'border');
                summaryReportBtn.classList.remove('bg-blue-600', 'text-white');
            }

            function showSummaryReport() {
                detailedReportView.classList.add('hidden');
                progresFilterContainer.classList.add('hidden');
                summaryReportView.classList.remove('hidden');

                summaryReportBtn.classList.add('bg-blue-600', 'text-white');
                summaryReportBtn.classList.remove('bg-white', 'text-slate-700', 'border');
                
                detailedReportBtn.classList.add('bg-white', 'text-slate-700', 'border');
                detailedReportBtn.classList.remove('bg-blue-600', 'text-white');
            }

            detailedReportBtn.addEventListener('click', showDetailedReport);
            summaryReportBtn.addEventListener('click', showSummaryReport);
            // =============================================

            // --- FUNGSI UNTUK MODAL SURAT ---
            function showSuratList() {
                suratPreview.classList.add('hidden');
                suratList.classList.remove('hidden');
                suratModalTitle.textContent = 'Pilih Jenis Surat';
                suratIframe.src = 'about:blank';
            }

            openSuratModalBtn.addEventListener('click', () => openModal(suratModal));
            closeSuratModalBtn.addEventListener('click', () => {
                closeModal(suratModal);
                setTimeout(showSuratList, 300);
            });
            suratModal.addEventListener('click', (e) => {
                if (e.target === suratModal) {
                    closeModal(suratModal);
                    setTimeout(showSuratList, 300);
                }
            });

            suratModalButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const title = button.getAttribute('data-title');
                    const pdfSrc = button.getAttribute('data-pdf-src');
                    const downloadSrc = button.getAttribute('data-download-src');
                    suratModalTitle.textContent = `Preview: ${title}`;
                    suratIframe.src = pdfSrc;
                    suratDownloadBtn.href = downloadSrc;
                    suratList.classList.add('hidden');
                    suratPreview.classList.remove('hidden');
                });
            });

            suratBackBtn.addEventListener('click', showSuratList);

            // --- Event Listener Modal Travel ---
            openTravelModalBtn.addEventListener('click', () => openModal(travelModal));
            closeTravelModalBtn.addEventListener('click', () => closeModal(travelModal));
            travelModal.addEventListener('click', (e) => {
                if (e.target === travelModal) closeModal(travelModal);
            });

            // --- Event Listener Modal "Soon" ---
            openSoonModalBtns.forEach(btn => {
                btn.addEventListener('click', () => openModal(soonModal));
            });
            closeSoonModalBtn.addEventListener('click', () => closeModal(soonModal));
            soonModal.addEventListener('click', (e) => {
                if (e.target === soonModal) closeModal(soonModal); 
            });

            // --- Event Listener Modal Password Petugas ---
            const resetPetugasModal = () => {
                petugasPasswordInput.value = ''; // Selalu kosongkan password
                petugasPasswordError.classList.add('hidden'); // Sembunyikan error
                closeModal(petugasPasswordModal); // Tutup modal
            };

            openPetugasPasswordBtn.addEventListener('click', () => {
                openModal(petugasPasswordModal);
                petugasPasswordInput.focus(); // Langsung fokus ke input
            });
            
            closePetugasPasswordModalBtn.addEventListener('click', resetPetugasModal);
            
            petugasPasswordModal.addEventListener('click', (e) => {
                if (e.target === petugasPasswordModal) {
                    resetPetugasModal();
                }
            });

            petugasPasswordForm.addEventListener('submit', (e) => {
                e.preventDefault(); 
                const password = petugasPasswordInput.value;

                if (password === '1234') {
                    resetPetugasModal(); 
                    window.location.href = 'Form.html'; 
                } else {
                    petugasPasswordError.classList.remove('hidden'); 
                    petugasPasswordInput.value = ''; 
                    petugasPasswordInput.focus(); 
                }
            });


            // --- Event Listener Modal Link Sekolah (BARU) ---
            const resetSekolahModal = () => {
                closeModal(sekolahModal);
                setTimeout(() => { // Tunda pembersihan agar tidak berkedip
                    qrcodeDiv.innerHTML = ''; 
                    copyMessage.classList.add('hidden');
                    copyMessage.classList.remove('text-red-500');
                    copyMessage.classList.add('text-green-500');
                }, 300);
            };

            openSekolahModalBtn.addEventListener('click', () => {
                // Buat URL absolut ke Sekolah.html
                const linkToSekolah = new URL('Sekolah.html', window.location.href).href;
                sekolahLinkInput.value = linkToSekolah;
                
                openModal(sekolahModal);
                
                // Generate QR Code
                qrcodeDiv.innerHTML = ''; // Bersihkan QR code sebelumnya
                if (typeof QRCode !== 'undefined') {
                    try {
                        new QRCode(qrcodeDiv, {
                            text: linkToSekolah,
                            width: 224, // 14rem (w-56)
                            height: 224, // 14rem (h-56)
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                    } catch(e) {
                        console.error("Gagal membuat QR Code:", e);
                        qrcodeDiv.innerHTML = "<p class='text-red-500 text-sm'>Gagal memuat QR Code.</p>";
                    }
                } else {
                    console.warn("QRCode library (qrcode.min.js) belum dimuat.");
                    qrcodeDiv.innerHTML = "<p class='text-sm text-slate-500'>Memuat QR Code...</p>";
                }
            });

            closeSekolahModalBtn.addEventListener('click', resetSekolahModal);

            sekolahModal.addEventListener('click', (e) => {
                if (e.target === sekolahModal) {
                    resetSekolahModal();
                }
            });

            copyLinkBtn.addEventListener('click', () => {
                sekolahLinkInput.select(); // Pilih teks di input
                sekolahLinkInput.setSelectionRange(0, 99999); // Untuk perangkat mobile
                
                try {
                    // Gunakan document.execCommand untuk kompatibilitas
                    document.execCommand('copy'); 
                    
                    copyMessage.textContent = 'Tautan disalin!';
                    copyMessage.classList.remove('hidden');
                    copyMessage.classList.remove('text-red-500');
                    copyMessage.classList.add('text-green-500');
                    
                    setTimeout(() => {
                        copyMessage.classList.add('hidden');
                    }, 2000); // Sembunyikan pesan setelah 2 detik
                        
                } catch (err) {
                    console.error('Gagal menyalin tautan:', err);
                    copyMessage.textContent = 'Gagal menyalin.';
                    copyMessage.classList.remove('hidden');
                    copyMessage.classList.remove('text-green-500');
                    copyMessage.classList.add('text-red-500');
                }
            });

            // =============================================
            // BARU: FUNGSI UNTUK DATA PROGRES
            // =============================================

            /**
             * Helper untuk mendapatkan NPSN dari dokumen data,
             * menangani nama field yang berbeda-beda.
             */
            function getNPSNFromDoc(data, colName) {
                switch(colName) {
                    case 'fgd':
                        return data.npsn_fgd || data.npsn;
                    case 'wawancara_guru':
                        return data.npsn || data.npsn_fgd;
                    case 'observasi':
                        return data.npsn_obs || data.npsn || data.npsn_fgd;
                    case 'wawancara_murid':
                        return data.npsn_murid || data.npsn || data.npsn_fgd;
                    case 'laporan':
                        return data.npsn_lpr || data.npsn || data.npsn_fgd;
                    // Asumsi untuk 'program'
                    case 'program':
                        return data.npsn_program || data.npsn; 
                    default:
                        // Menangani 'program_sekolah' dan default
                        return data.npsn;
                }
            }

            /**
             * Membuat listener onSnapshot untuk koleksi data (FGD, Laporan, dll).
             */
            function createSubmissionListener(collectionName, targetMap) {
                if (!db) return;
                const colRef = collection(db, collectionName);
                
                onSnapshot(colRef, (snapshot) => {
                    targetMap.clear(); // Hapus data lama
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        const npsn = getNPSNFromDoc(data, collectionName);
                        if (npsn) {
                            // Cukup tandai bahwa NPSN ini sudah submit (kita tidak peduli jumlahnya, hanya "apakah sudah" atau "belum")
                            targetMap.set(npsn, true); 
                        }
                    });
                    
                    console.log(`Peta data ${collectionName} diperbarui: ${targetMap.size} entri unik.`);
                    
                    // Render ulang tabel progres rinci dan rekap
                    applyProgresFilters();
                    updateProgresSummary();

                }, (error) => {
                    console.error(`Error listening to ${collectionName}:`, error);
                });
            }

            /**
             * Membuat item UI untuk modal rekap progres (per judul form).
             */
            function createProgressItem(title, count, total, percent) {
                // Tentukan warna berdasarkan persentase
                let bgColor = 'bg-blue-600';
                if (percent < 30) bgColor = 'bg-red-500';
                else if (percent < 70) bgColor = 'bg-yellow-500';
                else if (percent >= 100) bgColor = 'bg-green-600';

                // Pastikan persen tidak lebih dari 100
                const displayPercent = Math.min(percent, 100);

                return `
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="text-lg font-semibold text-slate-700">${title}</h4>
                            <span class="text-sm font-medium text-slate-500">${count} / ${total} Sekolah</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-4 overflow-hidden">
                            <div class="${bgColor} h-4 rounded-full text-center text-white text-xs font-bold leading-4 transition-all" style="width: ${displayPercent.toFixed(0)}%">
                                ${displayPercent.toFixed(0)}%
                            </div>
                        </div>
                    </div>
                `;
            }

            /**
             * Memperbarui konten modal rekap progres (per judul form).
             */
            function updateProgresSummary() {
                const totalSchools = allSekolahList.length;
                if (!progresSummaryContent) return;

                if (totalSchools === 0) {
                    progresSummaryContent.innerHTML = `<p class="text-center text-slate-500 p-6">Data sekolah belum dimuat...</p>`;
                    return;
                }

                const fgdCount = fgdSubmissions.size;
                const guruCount = guruSubmissions.size;
                const observasiCount = observasiSubmissions.size;
                const muridCount = muridSubmissions.size;
                const laporanCount = laporanSubmissions.size;
                const programCount = programSubmissions.size; // BARU

                const fgdPercent = (fgdCount / totalSchools) * 100;
                const guruPercent = (guruCount / totalSchools) * 100;
                const observasiPercent = (observasiCount / totalSchools) * 100;
                const muridPercent = (muridCount / totalSchools) * 100;
                const laporanPercent = (laporanCount / totalSchools) * 100;
                const programPercent = (programCount / totalSchools) * 100; // BARU
                
                const totalSubmissions = fgdCount + guruCount + observasiCount + muridCount + laporanCount + programCount;
                const totalPossible = totalSchools * TOTAL_FORMS; // 6 forms
                const overallPercent = totalPossible > 0 ? (totalSubmissions / totalPossible) * 100 : 0;

                let html = `<div class="space-y-5">`;
                html += createProgressItem('Progres Keseluruhan', totalSubmissions, totalPossible, overallPercent);
                html += '<hr class="my-6">';
                html += createProgressItem('Observasi', observasiCount, totalSchools, observasiPercent);
                html += createProgressItem('FGD', fgdCount, totalSchools, fgdPercent);
                html += createProgressItem('Wawancara Guru', guruCount, totalSchools, guruPercent);
                html += createProgressItem('Wawancara Murid', muridCount, totalSchools, muridPercent);
                html += createProgressItem('Laporan', laporanCount, totalSchools, laporanPercent);
                html += createProgressItem('Program', programCount, totalSchools, programPercent); // BARU
                html += `</div>`;
                
                progresSummaryContent.innerHTML = html;
            }
            
            // =============================================
            // AKHIR FUNGSI PROGRES
            // =============================================


            // --- FUNGSI TABEL DAN FILTER ---

            /**
             * REVERT: Mengisi tabel dataModal (Data Lokus)
             * (Versi ini TIDAK menampilkan progres)
             */
            function populateTable(data) {
                tableBody.innerHTML = ''; 
                
                if (data.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center p-6 text-slate-500">
                                Data tidak ditemukan.
                            </td>
                        </tr>
                    `;
                    return;
                }

                data.forEach(item => {
                    const row = `
                        <tr class="hover:bg-slate-50">
                            <td class="p-4">${item.npsn || '-'}</td>
                            <td class="p-4 font-medium text-slate-800">${item.sekolah || '-'}</td>
                            <td class="p-4">${item.provinsi || '-'}</td>
                            <td class="p-4">${item.kota || '-'}</td>
                            <td class="p-4">${item.petugas1 || '-'}</td>
                            <td class="p-4">${item.petugas2 || '-'}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }

            /**
             * BARU: Helper untuk ikon ceklis
             */
            function renderCheck(map, npsn) {
                return map.has(npsn) 
                    ? '<i class="fas fa-check-circle text-green-500" title="Selesai"></i>' 
                    : '<i class="fas fa-times-circle text-slate-300" title="Belum"></i>';
            }

            /**
             * BARU: Mengisi tabel progres rinci (di progresModal)
             */
            function populateDetailedProgressTable(data) {
                progresDetailedTableBody.innerHTML = '';
                
                if (data.length === 0) {
                    progresDetailedTableBody.innerHTML = `
                        <tr>
                            <td colspan="12" class="text-center p-6 text-slate-500">
                                Data tidak ditemukan untuk filter ini.
                            </td>
                        </tr>
                    `;
                    return;
                }

                data.forEach((item, index) => {
                    let submittedForms = 0;
                    const npsn = item.npsn;
                    if (observasiSubmissions.has(npsn)) submittedForms++;
                    if (fgdSubmissions.has(npsn)) submittedForms++;
                    if (guruSubmissions.has(npsn)) submittedForms++;
                    if (muridSubmissions.has(npsn)) submittedForms++;
                    if (laporanSubmissions.has(npsn)) submittedForms++;
                    if (programSubmissions.has(npsn)) submittedForms++;
                    
                    const progressPercent = (submittedForms / TOTAL_FORMS) * 100;
                    let progressColor = 'text-slate-500';
                    if (progressPercent === 100) progressColor = 'text-green-600';
                    else if (progressPercent > 0) progressColor = 'text-blue-600';

                    const row = `
                        <tr class="hover:bg-slate-50">
                            <td class="p-3 text-center">${index + 1}</td>
                            <td class="p-3">${item.provinsi || '-'}</td>
                            <td class="p-3">${item.kota || '-'}</td>
                            <td class="p-3">${item.npsn || '-'}</td>
                            <td class="p-3 font-medium text-slate-800">${item.sekolah || '-'}</td>
                            <td class="p-3 font-bold text-center ${progressColor}">
                                ${progressPercent.toFixed(0)}%
                            </td>
                            <td class="p-3 text-center">${renderCheck(observasiSubmissions, npsn)}</td>
                            <td class="p-3 text-center">${renderCheck(fgdSubmissions, npsn)}</td>
                            <td class="p-3 text-center">${renderCheck(guruSubmissions, npsn)}</td>
                            <td class="p-3 text-center">${renderCheck(muridSubmissions, npsn)}</td>
                            <td class="p-3 text-center">${renderCheck(laporanSubmissions, npsn)}</td>
                            <td class="p-3 text-center">${renderCheck(programSubmissions, npsn)}</td>
                        </tr>
                    `;
                    progresDetailedTableBody.innerHTML += row;
                });
            }


            let currentProvinsi = 'semua';
            let currentSekolah = 'semua';
            let currentProgresProvinsi = 'semua';
            let currentProgresSekolah = 'semua';

            /**
             * DIPERBARUI: Mengisi dropdown provinsi (untuk filter manapun)
             */
            function populateProvinsiFilter(filterElement) {
                if (!filterElement) return;
                const currentValue = filterElement.value; // Simpan nilai saat ini
                const provinsi = ['semua', ...new Set(allSekolahList.map(item => item.provinsi).sort())];
                filterElement.innerHTML = '';
                
                provinsi.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p;
                    option.textContent = (p === 'semua') ? 'Semua Provinsi' : p;
                    filterElement.appendChild(option);
                });
                filterElement.value = currentValue; // Set kembali nilainya
            }

            /**
             * DIPERBARUI: Mengisi dropdown sekolah (untuk filter manapun)
             */
            function populateSekolahFilter(provinsi, sekolahFilterElement) {
                if (!sekolahFilterElement) return;
                const currentValue = sekolahFilterElement.value; // Simpan nilai saat ini
                sekolahFilterElement.innerHTML = '';
                let sekolahList = [];

                if (provinsi === 'semua') {
                    sekolahList = allSekolahList;
                    sekolahFilterElement.disabled = (allSekolahList.length === 0);
                } else {
                    sekolahList = allSekolahList.filter(item => item.provinsi === provinsi);
                    sekolahFilterElement.disabled = false;
                }

                const sekolah = ['semua', ...new Set(sekolahList.map(item => item.sekolah).sort())];
                
                sekolah.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s;
                    option.textContent = (s === 'semua') ? 'Semua Sekolah' : s;
                    sekolahFilterElement.appendChild(option);
                });
                
                // Coba set kembali nilai, jika tidak ada, set ke 'semua'
                if ([...sekolahFilterElement.options].map(o => o.value).includes(currentValue)) {
                    sekolahFilterElement.value = currentValue;
                } else {
                    sekolahFilterElement.value = 'semua';
                }
            }

            /**
             * Menerapkan filter untuk modal Data Lokus (dataModal)
             */
            function applyFilters() {
                let filteredData = allSekolahList;
                currentProvinsi = provinsiFilter.value;
                currentSekolah = sekolahFilter.value;

                if (currentProvinsi !== 'semua') {
                    filteredData = filteredData.filter(item => item.provinsi === currentProvinsi);
                }
                if (currentSekolah !== 'semua') {
                    filteredData = filteredData.filter(item => item.sekolah === currentSekolah);
                }
                populateTable(filteredData);
            }

            /**
             * BARU: Menerapkan filter untuk modal Progres Rinci (progresModal)
             */
            function applyProgresFilters() {
                let filteredData = allSekolahList;
                currentProgresProvinsi = progresProvinsiFilter.value;
                currentProgresSekolah = progresSekolahFilter.value;

                if (currentProgresProvinsi !== 'semua') {
                    filteredData = filteredData.filter(item => item.provinsi === currentProgresProvinsi);
                }
                if (currentProgresSekolah !== 'semua') {
                    filteredData = filteredData.filter(item => item.sekolah === currentProgresSekolah);
                }
                // Urutkan berdasarkan % progres (tertinggi ke terendah)
                filteredData.sort((a, b) => {
                    let progA = 0;
                    let progB = 0;
                    if (observasiSubmissions.has(a.npsn)) progA++;
                    if (fgdSubmissions.has(a.npsn)) progA++;
                    if (guruSubmissions.has(a.npsn)) progA++;
                    if (muridSubmissions.has(a.npsn)) progA++;
                    if (laporanSubmissions.has(a.npsn)) progA++;
                    if (programSubmissions.has(a.npsn)) progA++;
                    
                    if (observasiSubmissions.has(b.npsn)) progB++;
                    if (fgdSubmissions.has(b.npsn)) progB++;
                    if (guruSubmissions.has(b.npsn)) progB++;
                    if (muridSubmissions.has(b.npsn)) progB++;
                    if (laporanSubmissions.has(b.npsn)) progB++;
                    if (programSubmissions.has(b.npsn)) progB++;

                    return progB - progA; // Sort descending
                });
                populateDetailedProgressTable(filteredData);
            }

            // --- Event Listener untuk Filter ---
            provinsiFilter.addEventListener('change', (e) => {
                currentProvinsi = e.target.value;
                currentSekolah = 'semua'; 
                populateSekolahFilter(currentProvinsi, sekolahFilter); 
                applyFilters(); 
            });
            sekolahFilter.addEventListener('change', (e) => {
                currentSekolah = e.target.value;
                applyFilters();
            });

            // BARU: Event Listener for Progres Filter
            progresProvinsiFilter.addEventListener('change', (e) => {
                currentProgresProvinsi = e.target.value;
                currentProgresSekolah = 'semua';
                populateSekolahFilter(currentProgresProvinsi, progresSekolahFilter);
                applyProgresFilters();
            });
            progresSekolahFilter.addEventListener('change', (e) => {
                currentProgresSekolah = e.target.value;
                applyProgresFilters();
            });


            // --- Inisialisasi Saat Awal ---
            function initializeFilters() {
                // Set nilai default
                currentProvinsi = 'semua';
                currentSekolah = 'semua';
                currentProgresProvinsi = 'semua';
                currentProgresSekolah = 'semua';

                // Isi filter dataModal
                populateProvinsiFilter(provinsiFilter);
                populateSekolahFilter(currentProvinsi, sekolahFilter);
                applyFilters(); 
                
                // Isi filter progresModal
                populateProvinsiFilter(progresProvinsiFilter);
                populateSekolahFilter(currentProgresProvinsi, progresSekolahFilter);
                applyProgresFilters();
            }
            
            // PERUBAHAN 13: Memindahkan inisialisasi ke dalam listener Firebase
            if (db) {
                // 1. Listener untuk data master sekolah
                const sekolahCol = collection(db, "sekolah");
                onSnapshot(sekolahCol, (snapshot) => {
                    console.log(`Menerima ${snapshot.docs.length} data sekolah.`);
                    allSekolahList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); // Simpan ID
                    allSekolahList.sort((a, b) => (a.provinsi || "").localeCompare(b.provinsi || "") || (a.kota || "").localeCompare(b.kota || ""));
                    
                    // Setelah data sekolah diterima, inisialisasi semua filter dan tabel
                    initializeFilters();
                    // Dan perbarui modal rekap
                    updateProgresSummary();

                }, (error) => {
                    console.error("Error mengambil data sekolah:", error);
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-6 text-red-500">Error mengambil data: ${error.message}</td></tr>`;
                    progresDetailedTableBody.innerHTML = `<tr><td colspan="12" class="text-center p-6 text-red-500">Error mengambil data: ${error.message}</td></tr>`;
                });

                // =============================================
                // BARU: 2. Listener untuk semua data progres
                // =============================================
                createSubmissionListener('fgd', fgdSubmissions);
                createSubmissionListener('wawancara_guru', guruSubmissions);
                createSubmissionListener('observasi', observasiSubmissions);
                createSubmissionListener('wawancara_murid', muridSubmissions);
                createSubmissionListener('laporan', laporanSubmissions);
                
                // =============================================
                // === PERBAIKAN DI SINI ===
                // =============================================
                // Sebelumnya: createSubmissionListener('program', programSubmissions);
                // Diperbaiki menjadi:
                createSubmissionListener('program_sekolah', programSubmissions); // DISESUAIKAN
                // =============================================


            } else {
                 console.error("Koneksi database (db) tidak tersedia.");
                 tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-6 text-red-500">Koneksi database gagal.</td></tr>`;
                 progresDetailedTableBody.innerHTML = `<tr><td colspan="12" class="text-center p-6 text-red-500">Koneksi database gagal.</td></tr>`;
            }

        });
    </script>

</body>
</html>
